class Vector{static ZERO={x:0,y:0};static LEFT={x:-1,y:0};static RIGHT={x:1,y:0};static UP={x:0,y:-1};static DOWN={x:0,y:1};static add(v1,v2){return{x:v1.x+v2.x,y:v1.y+v2.y}}static distance(v1,v2){return Math.sqrt(Math.pow(v1.x-v2.x,2)+Math.pow(v1.y-v2.y,2))}static inverse(v){return{x:-v.x,y:-v.y}}static clone(v){return{x:v.x,y:v.y}}static equals(v1,v2){return v1.x==v2.x&&v1.y==v2.y}}class AI{static TURNS=[Vector.UP,Vector.DOWN,Vector.LEFT,Vector.RIGHT];static ROUTE_DEPTH_BASE=4;static DIRECTION_THROTTLE=8;static loadMaze(MazeCls){this.ROUTE_DEPTH=this.ROUTE_DEPTH_BASE,delete this.paths,this.mazeCls=MazeCls,this.generateIntersectionNodes()}static generateIntersectionNodes(){this.graph={};for(var x=0;x<28;x++)for(var y=0;y<36;y++){var tile={x:x,y:y};if(this.mazeCls.isWalkableTile(tile)){for(var turnCount=0,t=0;t<this.TURNS.length;t++){var testTile=Vector.add(tile,this.TURNS[t]);this.mazeCls.isWalkableTile(testTile)&&turnCount++}if(turnCount>2){var key=tile.x+","+tile.y;this.graph[key]=tile}}}}static shortestPathBFS(fromTile,toTile){var searchQueue=[fromTile],tileLookup={},directions=AI.TURNS;for(fromTile.path=[],tileLookup[fromTile.x+","+fromTile.y]=fromTile;searchQueue.length;){var searchTile=searchQueue.shift();if(Vector.equals(searchTile,toTile))return searchQueue=[],{path:searchTile.path,distance:searchTile.path.length};for(var i=0;i<directions.length;i++){var testTile=Vector.add(searchTile,directions[i]);testTile.x<0?testTile.x=27:testTile.x>27&&(testTile.x=0);var tileKey=testTile.x+","+testTile.y;this.mazeCls.isWallTile(testTile)||tileLookup[tileKey]||(testTile.path=searchTile.path.concat(directions[i]),tileLookup[tileKey]=testTile,searchQueue.push(testTile))}}}static analyze(pacman,scene){var tileLookup={},tile=pacman.tile,directions=AI.TURNS,firstGeneration=!0,searchQueue=[tile],nearestPellet=null,nearestPellets={},pelletHash={},allPellets=[],energizerHash={},nearestEnergizer=null,nearestEnergizers={},allEnergizers=[],nearestFruit=!1,ghostHash={},nearestFrightenedGhosts={},nearestGhosts={},allGhosts={},nearestIntersections={},allIntersections=[];for(pacman.stopped&&directions.push(Vector.ZERO),scene.energizers.forEach(e=>{energizerHash[e.tile.x+","+e.tile.y]=e}),scene.pellets.forEach(p=>{pelletHash[p.tile.x+","+p.tile.y]=p}),scene.ghosts.forEach(g=>{var ghostHashKey=g.tile.x+","+g.tile.y;ghostHash[ghostHashKey]=ghostHash[ghostHashKey]||{},ghostHash[ghostHashKey][g.name]=g}),tile.distance=0,tile.path=[],tileLookup[tile.x+","+tile.y]=tile;searchQueue.length;){var searchTile=searchQueue.shift(),searchDirection=searchTile.direction?searchTile.direction.x+","+searchTile.direction.y:"0,0",searchTileKey=searchTile.x+","+searchTile.y;this.graph[searchTileKey]&&!Vector.equals(scene.pacman.tile,searchTile)&&(nearestIntersections[searchDirection]||(nearestIntersections[searchDirection]=searchTile),allIntersections.push(searchTile)),energizerHash[searchTileKey]&&(nearestEnergizer||(nearestEnergizer=searchTile),nearestEnergizers[searchDirection]||(nearestEnergizers[searchDirection]=searchTile),allEnergizers.push(searchTile)),pelletHash[searchTileKey]&&(nearestPellet||(nearestPellet=searchTile),nearestPellets[searchDirection]||(nearestPellets[searchDirection]=searchTile),allPellets.push(searchTile)),!nearestFruit&&scene.fruit&&Vector.equals(scene.fruit,searchTile)&&(nearestFruit=searchTile);var ghosts=ghostHash[searchTileKey];if(ghosts){for(var name in ghosts){var ghost=ghosts[name];ghost.isFrightened?nearestFrightenedGhosts[searchDirection]||(nearestFrightenedGhosts[searchDirection]=searchTile):ghost.isEaten||ghost.isFrightened||nearestGhosts[searchDirection]||(nearestGhosts[searchDirection]=searchTile),ghost.isFrightened||(allGhosts[name]={distance:searchTile.distance,direction:searchTile.direction})}searchTile.ghosts=ghosts}for(var i=0;i<directions.length;i++){var testTile=Vector.add(searchTile,directions[i]);testTile.x<0?testTile.x=27:testTile.x>27&&(testTile.x=0);var tileKey=testTile.x+","+testTile.y;this.mazeCls.isWallTile(testTile)||tileLookup[tileKey]||(testTile.distance=searchTile.distance+1,testTile.direction=firstGeneration?directions[i]:searchTile.direction,testTile.path=searchTile.path.concat(directions[i]),tileLookup[tileKey]=testTile,searchQueue.push(testTile))}firstGeneration=!1}return{nearestPellet:nearestPellet,nearestPellets:nearestPellets,nearestEnergizer:nearestEnergizer,nearestEnergizers:nearestEnergizers,allIntersections:allIntersections}}static evaluate(scene){if(!scene.levelComplete)if(this.directionThrottle)this.directionThrottle--;else if(!this.mazeCls.isWarpTile(scene.pacman.tile)){this.ghostHash={},scene.ghosts.forEach(g=>{this.ghostHash[g.tile.x+","+g.tile.y]=g}),this.energizerHash={},scene.energizers.forEach(e=>{this.energizerHash[e.tile.x+","+e.tile.y]=e}),this.pelletHash={},scene.pellets.forEach(p=>{this.pelletHash[p.tile.x+","+p.tile.y]=p}),this.fruitHash={},scene.fruit&&(this.fruitHash[scene.fruit.tile.x+","+scene.fruit.tile.y]=scene.fruit);var startTile=Vector.clone(scene.pacman.tile),leaves=[],paths=[];this.sawThing=!1,this.ROUTE_DEPTH=this.ROUTE_DEPTH_BASE*(scene.fruit||scene.pacman.isEnergized?2:1),AI.createRouteTree(scene,startTile,0,leaves),AI.scoreRoutes(scene,startTile,1,paths),this.paths=startTile,paths.sort((p1,p2)=>p2.score-p1.score);var safeRoutes=paths.filter(p=>p[0].safe>0),dangerousRoutes=paths.filter(p=>0==p[0].safe),unsafeRoutes=paths.filter(p=>p[0].safe<0),pacmanOldDirection=Vector.clone(scene.pacman.direction);if(this.sawThing){var choosePaths;this.sawThing&&delete this.locatePellet,safeRoutes.length?choosePaths=safeRoutes:dangerousRoutes.length?choosePaths=dangerousRoutes:unsafeRoutes.length&&(choosePaths=unsafeRoutes);for(var direction=scene.pacman.direction,topScore=choosePaths[0].score,bestCurDirection=[],bestDiffDirection=[],i=0,choice;i<choosePaths.length;i++)choosePaths[i].score==topScore&&Vector.equals(choosePaths[i][0].direction,direction)?bestCurDirection.push(choosePaths[i]):choosePaths[i].score==topScore&&bestDiffDirection.push(choosePaths[i]);if(bestCurDirection.length)bestCurDirection[choice=Math.floor(Math.random()*bestCurDirection.length)].forEach(t=>t.chosen=!0),scene.pacman.direction=bestCurDirection[choice][0].direction;else if(bestDiffDirection.length){var choice;bestDiffDirection[choice=Math.floor(Math.random()*bestDiffDirection.length)].forEach(t=>t.chosen=!0),scene.pacman.direction=bestDiffDirection[choice][0].direction}}else{if(!this.locatePellet){var state=this.analyze(scene.pacman,scene);this.locatePellet=state.nearestPellet||state.nearestEnergizer}if(this.locatePellet){for(var path=this.shortestPathBFS(scene.pacman.tile,this.locatePellet).path,testTile=Vector.add(scene.pacman.tile,path[0]),choices=[],i=0;i<AI.paths.children.length;i++)if(Vector.equals(testTile,AI.paths.children[i])){if(AI.paths.children[i].safe>0)return Vector.equals(scene.pacman.direction,path[0])||(this.directionThrottle=this.DIRECTION_THROTTLE),void(scene.pacman.direction=path[0]);choices.push(AI.paths.children[i])}else choices.push(AI.paths.children[i]);choices.length&&(this.sawThing=!1,choices.sort((c1,c2)=>c2.safe-c1.safe),scene.pacman.direction=choices[0].direction)}}Vector.equals(pacmanOldDirection,scene.pacman.direction)||(this.directionThrottle=this.DIRECTION_THROTTLE)}}static createRouteTree(scene,tile,depth,leaves){if(depth<=AI.ROUTE_DEPTH){depth++;for(var i=0;i<this.TURNS.length;i++){var testTile=Vector.add(tile,this.TURNS[i]);testTile.x<-1&&(testTile.x=29),testTile.x>29&&(testTile.x=-1),tile.parent&&Vector.equals(testTile,tile.parent)||!this.mazeCls.isWalkableTile(testTile)||(testTile.direction=this.TURNS[i],testTile.parent=tile,tile.children=tile.children||[],tile.children.push(testTile),this.createRouteTree(scene,testTile,depth,leaves))}}else leaves.push(tile)}static scoreRoutes(scene,tile,safe,paths){tile.safe=safe;var key=tile.x+","+tile.y,ghost;if((ghost=this.ghostHash[key])&&!ghost.isFrightened&&!ghost.isEaten){safe=-1,tile.safe=-1;for(var parentTile=tile.parent,tsafe=safe,movingAway=this.ghostMovingAway(ghost,scene.pacman);parentTile;)movingAway&&parentTile.children.length>1&&parentTile.safe>0&&(tsafe=0),parentTile.safe=tsafe,parentTile=parentTile.parent}if(tile.children)for(var i=0;i<tile.children.length;i++)this.scoreRoutes(scene,tile.children[i],safe,paths);else{var path=[],score=0,distance=1;do{tile.parent&&path.unshift(tile);var key=tile.x+","+tile.y,ghost=this.ghostHash[key],fruit=this.fruitHash[key],tscore=0;this.pelletHash[key]?(this.sawThing=!0,tscore+=10*distance):this.energizerHash[key]&&!scene.pacman.isEnergized?(this.sawThing=!0,tscore+=safe<1?1e3:50):fruit&&(this.sawThing=!0,tscore+=10*fruit.points*distance),tile.children&&tile.children.length>1&&(tscore+=10*(tile.children.length-2)),ghost&&(ghost.isFrightened?(this.sawThing=!0,tscore+=500*distance):ghost.isEaten||this.ghostMovingAway(ghost,scene.pacman)||(tscore-=100*distance)),tile.score=tscore,score+=tscore,tile=tile.parent,distance++}while(tile);path.score=score,paths.push(path)}}static ghostMovingAway(ghost,pacman){var movingAway=!1;return ghost.direction.x?movingAway=ghost.x<pacman.x&&ghost.direction.x<0||ghost.x>pacman.x&&ghost.direction.x>0:ghost.direction.y&&(movingAway=ghost.y<pacman.y&&ghost.direction.y<0||ghost.y>pacman.y&&ghost.direction.y>0),movingAway}static drawPaths(context,tile){if(tile=tile||this.paths,context.beginPath(),context.lineWidth=1,tile.chosen?context.strokeStyle="#0000FF":tile.safe<0?context.strokeStyle="#FF0000":tile.safe>0?context.strokeStyle="#00FF00":context.strokeStyle="#FFA500",context.strokeRect(8*tile.x,8*tile.y,8,8),tile.children)for(var i=0;i<tile.children.length;i++)this.drawPaths(context,tile.children[i])}}class Sound{static initialize(){var AudioContext=window.AudioContext||window.webkitAudioContext;this.context=new AudioContext,this.loadSound("res/pacman/sfx.ogg").then(buffer=>this.sfx_0=buffer),this.loadSound("res/mspacman/sfx.ogg").then(buffer=>this.sfx_1=buffer)}static playing={};static sfx=[{siren0:{start:17.125,end:17.504},siren1:{start:18.51595,end:18.788359},siren2:{start:19.84,end:20.134},siren3:{start:21.14,end:21.3985},retreating:{start:22.399,end:22.663},power_pellet:{start:23.852,end:23.988},intermission:{start:25.255,end:30.418},die:{start:2.692,end:4.184},munch0:{start:5.315,end:5.394},munch1:{start:6.443,end:6.525},game_start:{start:36.57,end:40.776},eat_ghost:{start:8.794,end:9.301},extra_life:{start:10.387,end:12.351},eat_fruit:{start:13.463,end:13.846},credit:{start:14.38,end:14.595}},{credit:{start:1.111,end:1.357},game_start:{start:3.087,end:7.313},siren0:{start:50.562,end:50.695},siren1:{start:52.118,end:52.269},siren2:{start:53.576,end:53.743},siren3:{start:54.824,end:55.008},munch0:{start:48.396,end:48.526},munch1:{start:48.396,end:48.526},power_pellet:{start:56.99,end:95.991},retreating:{start:99.063,end:99.664},extra_life:{start:100.148,end:102.137},eat_fruit:{start:103.146,end:103.533},eat_ghost:{start:106.292,end:106.795},fruit_bounce:{start:107.293,end:107.496},die:{start:104.427,end:105.567},act1:{start:9.889,end:18.47},act2:{start:19.049,end:40.421},act3:{start:41.195,end:46.171}}];static siren=0;static resetSiren(){this.siren=0}static checkSiren(pelletsLeft){pelletsLeft>108?this.setSiren(0):pelletsLeft>44?this.setSiren(1):pelletsLeft>12?this.setSiren(2):this.setSiren(3)}static setSiren(siren){this.siren!=siren&&this.stop("siren"),this.siren=siren}static playLoop(fx){if("siren"==fx&&(fx+=this.siren),!this.sfx[Game.GAME_MODE][fx].source){this.playing[fx]=!0;var source=this.context.createBufferSource();source.buffer=this["sfx_"+Game.GAME_MODE],source.loop=!0;var loop=this.sfx[Game.GAME_MODE][fx];return source.loopStart=loop.start,source.loopEnd=loop.end,source.connect(this.context.destination),source.start(0,loop.start),this.sfx[Game.GAME_MODE][fx].source=source,source.addEventListener("ended",()=>{delete this.sfx[Game.GAME_MODE][fx].source,delete this.playing[fx]}),source}}static munch=0;static playOnce(fx){if("munch"==fx&&(this.stop("munch"),fx+=this.munch,this.munch=(this.munch+1)%2),!this.sfx[Game.GAME_MODE][fx].source){var source=this.context.createBufferSource();source.buffer=this["sfx_"+Game.GAME_MODE];var clip=this.sfx[Game.GAME_MODE][fx];return source.connect(this.context.destination),source.start(0,clip.start,clip.end-clip.start),this.sfx[Game.GAME_MODE][fx].playing=!0,this.sfx[Game.GAME_MODE][fx].source=source,source.addEventListener("ended",()=>{delete this.sfx[Game.GAME_MODE][fx].source}),source}}static stop(fx){"siren"==fx&&(fx+=this.siren),this.sfx[Game.GAME_MODE][fx]&&this.sfx[Game.GAME_MODE][fx].source&&this.sfx[Game.GAME_MODE][fx].source.stop()}static stopAll(){for(var fx in this.playing)this.stop(fx)}static resume(){this.context&&this.context.resume()}static suspend(){this.context&&this.context.suspend()}static loadSound(url){return new Promise((resolve,reject)=>{var request=new XMLHttpRequest;request.open("GET",url,!0),request.responseType="arraybuffer",request.onload=()=>{this.context.decodeAudioData(request.response,(function(buffer){resolve(buffer)}))},request.send()})}}class Timer{constructor(){}start(ticks,callback){this.originalTicks=ticks,this.ticks=ticks,this.callback=callback,ticks<=0&&(this.ticks=0,this.callback.call(this))}reset(ticks){this.ticks=ticks||this.originalTicks}stop(){this.ticks=0}tick(){return this.ticks>0&&(this.ticks--,0==this.ticks&&this.callback.call(this)),this.ticks>0}}class Input{static lastKey=null;static buffer=[];static keyState={};static reset(){Input.buffer=[]}static onKeyDown(e){return Input.keyState[""+e.keyCode]=1,Input.lastKey=e.keyCode,e.keyCode>=37&&e.keyCode<=40?(e.preventDefault(),!1):32==e.keyCode?(GAME.pauseGame=!GAME.pauseGame,e.preventDefault(),!1):70==e.keyCode?(GAME.pauseGame=!0,Input.watch(),SceneManager.update(),e.preventDefault(),!1):(Input.keyDown||(Input.keyPress=e.keyCode),void(Input.keyDown=!0))}static onKeyUp(e){delete Input.keyState[e.keyCode],delete Input.lastKey,Input.keyDown=!1}static watch(){var nextDirection;Input.keyState[37]||Input.keyState[65]?nextDirection=Vector.LEFT:Input.keyState[39]||Input.keyState[68]?nextDirection=Vector.RIGHT:Input.keyState[38]||Input.keyState[87]?nextDirection=Vector.UP:(Input.keyState[40]||Input.keyState[83])&&(nextDirection=Vector.DOWN),Input.buffer.unshift(nextDirection),3==Input.buffer.length&&Input.buffer.pop()}static readKeyPress(){var k=this.keyPress;return delete this.keyPress,k}static readBuffer(){return 2==Input.buffer.length?Input.buffer[1]:null}}document.onkeydown=Input.onKeyDown,document.onkeyup=Input.onKeyUp;class Scene{constructor(context){this.context=context}tick(){}draw(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height)}}class ScriptScene extends Scene{constructor(context,keyFrames){super(context),this.keyFrames=keyFrames,this.drawables=[],this.actors=[],this.ctr=0}tick(){this.ctr++;var keyFrame=this.keyFrames[this.ctr];"loop"==keyFrame&&(this.ctr=0,keyFrame=this.keyFrames[this.ctr]),"end"==keyFrame?SceneManager.popScene():keyFrame&&keyFrame.call(this);for(var i=0;i<2;i++)this.actors.forEach(a=>a.tick())}draw(){Scene.prototype.draw.call(this),this.drawables.forEach(d=>d.draw())}}class SceneManager{static stack=[];static pushScene(scene){this.stack.push(scene)}static popScene(){this.stack.pop()}static replaceScene(scene){this.popScene(),this.pushScene(scene)}static currentScene(){return this.stack.length?this.stack[this.stack.length-1]:null}static update(){var scene=this.currentScene();scene&&(scene.tick(),scene.draw())}}class CreditsScene extends Scene{constructor(context){super(context),this.pressEnter=new Text(this,"PRESS ENTER","pink",72,224),this.pacman=new Pacman(this,56,92),this.pacman.animation=Pacman.ANIM_SLOMO,this.pacman2=new Pacman(this,160,92),this.pacman2.animation=Pacman.ANIM_SLOMO,this.pacmanText=new Text(this,"PACMAN","white",92,96),this.pacman.direction=Vector.RIGHT,this.mspacman=new MsPacman(this,56,140),this.mspacman.animation=Pacman.ANIM_SLOMO,this.mspacman2=new MsPacman(this,160,140),this.mspacman2.animation=Pacman.ANIM_SLOMO,this.mspacmanText=new Text(this,"MS PACMAN","orange",80,144),this.mspacman.direction=Vector.RIGHT,this.canSelectGame=!0,this.pellets=[];for(var i=4;i<=24;i++)this.pellets.push(new Pellet(this,8*i,32));for(var i=5;i<=23;i++)this.pellets.push(new Pellet(this,192,8*i));for(var i=24;i>=4;i--)this.pellets.push(new Pellet(this,8*i,192));for(var i=23;i>=5;i--)this.pellets.push(new Pellet(this,32,8*i));this.colorIndex=[0,10,20,30,40,50,60,70],this.colorCounter=0}tick(){if(this.colorCounter++,2==this.colorCounter&&(this.colorCounter=0,this.colorIndex=this.colorIndex.map(i=>{delete this.pellets[i].color;var idx=(i+1)%this.pellets.length;return this.pellets[idx].color="#fc0d1b",idx})),13==Input.lastKey)return Game.GAME_MODE==Game.GAME_PACMAN?(TitleScene=PacmanTitleScene,StartScene=PacmanStartScene,CutScene1=PacmanCutScene1,CutScene2=PacmanCutScene2,CutScene3=PacmanCutScene3,LevelSprite=PacmanLevelSprite,PacClass=Pacman,Points=PacmanPoints,Fruit=PacmanFruit):(TitleScene=MsPacmanTitleScene,StartScene=MsPacmanStartScene,CutScene1=MsPacmanCutScene1,CutScene2=MsPacmanCutScene2,CutScene3=MsPacmanCutScene3,LevelSprite=MsPacmanLevelSprite,PacClass=MsPacman,Points=MsPacmanPoints,Fruit=MsPacmanFruit),SceneManager.pushScene(new TitleScene(this.context)),void Sound.initialize();38!=Input.lastKey&&40!=Input.lastKey||!this.canSelectGame?Input.lastKey||(this.canSelectGame=!0):(Game.GAME_MODE=(Game.GAME_MODE+1)%2,this.canSelectGame=!1),Game.GAME_MODE==Game.GAME_PACMAN?(this.pacman.unfreeze(),this.mspacman.freeze(),this.pacman2.unfreeze(),this.mspacman2.freeze(),this.pacmanText.color="white",this.mspacmanText.color="orange"):(this.pacman.freeze(),this.mspacman.unfreeze(),this.pacman2.freeze(),this.mspacman2.unfreeze(),this.pacmanText.color="orange",this.mspacmanText.color="white")}draw(){Scene.prototype.draw.call(this),this.pellets.forEach(p=>p.draw()),this.pacman.draw(),this.pacman2.draw(),this.pacmanText.draw(),this.mspacman.draw(),this.mspacman2.draw(),this.mspacmanText.draw(),this.pacmanText.draw(),this.pressEnter.draw()}}class GameScene extends Scene{static MODE_CHASE=0;static MODE_SCATTER=1;constructor(context,numPlayers){super(context),this.readyText=new Text(this,"READY!","yellow",88,160),this.gameOverText=new Text(this,"GAME  OVER","red",72,160),this.gameOverText.hide(),this.scoreOneText=new Text(this,"00","white",48,8,"right"),this.scoreTwoText=new Text(this,"00","white",200,8,"right"),1==numPlayers&&this.scoreTwoText.hide(),this.oneUpLabel=new Text(this,"1UP","white",24,0),this.highScoreLabel=new Text(this,"HIGH SCORE","white",72,0),this.highScoreText=new Text(this,this.highScore,"white",128,8,"right"),this.twoUpLabel=new Text(this,"2UP","white",176,0),this.playerLabel=new Text(this,"PLAYER ONE","blue",72,112),this.creditLabel=new Text(this,"CREDIT","white",8,280),this.creditLabel.hide(),this.credits=new Text(this,""+Game.CREDITS,"white",72,280,"right"),this.credits.hide(),this.textSprites=[this.readyText,this.gameOverText,this.scoreOneText,this.oneUpLabel,this.highScoreLabel,this.twoUpLabel,this.scoreTwoText,this.playerLabel,this.highScoreText,this.creditLabel,this.credits],this.scoreText=[this.scoreOneText,this.scoreTwoText],this.curPlayer=0,this.pellets=[],this.energizers=[],this.numPlayers=numPlayers,this.players=[];for(var i=0;i<this.numPlayers;i++){var pacman=new PacClass(this,105,204);pacman.level=-i,pacman.lives=3,this.players.push(pacman)}this.ghosts=[new Clyde(this,120,132),new Inky(this,88,132),new Pinky(this,104,132),new Blinky(this,104,108)],this.ghosts.Blinky=this.ghosts[3],this.ghosts.Pinky=this.ghosts[2],this.ghosts.Inky=this.ghosts[1],this.ghosts.Clyde=this.ghosts[0],this.scatterChase=new ScatterChase(this),this.startLevelTimer=new Timer,this.lastPelletEatenTimer=new Timer,this.freezeTimer=new Timer,this.frightenTimer=new Timer,this.frightenFlashTimer=new Timer,this.levelSprite=new LevelSprite(this),this.livesSprite=new LivesSprite(this),this.loadPlayer(0)}get pelletsEaten(){var totalPellets;return this.mazeClass.tiles.filter(t=>t.pellet).length+this.mazeClass.tiles.filter(t=>t.energizer).length-this.pelletsLeft}get pelletsLeft(){return this.pellets.length+this.energizers.length}get highScore(){var score=Game.getHighScore(Game.GAME_MODE);return score||""}loadPlayer(player){if(this.curPlayer=player,this.pacman=this.players[player],this.playerLabel.text="PLAYER "+(player?"TWO":"ONE"),this.level=this.pacman.level,this.level<1){var newGame=!this.level;this.level=1,this.pacman.level=1,this.nextLevel(newGame)}else this.pellets=this.pacman.pellets,this.energizers=this.pacman.energizers,this.resetLevel()}nextLevel(newGame){Sound.resetSiren(),this.levelStarting=!0,this.maze=Maze.getMaze(this),this.mazeClass=this.maze.constructor,this.ghosts.forEach(g=>g.pelletCounter=0),this.pellets=this.mazeClass.tiles.filter(t=>t.pellet).map(t=>new Pellet(this,8*t.x,8*t.y)),this.energizers=this.mazeClass.tiles.filter(t=>t.energizer).map(t=>new Energizer(this,8*t.x,8*t.y)),this.useGlobalPelletLimit=!1,this.pacman.pellets=this.pellets,this.pacman.energizers=this.energizers,newGame?(Sound.playOnce("game_start"),this.playerLabel.show(),this.ghosts.forEach(g=>g.hide()),this.startLevelTimer.start(180,()=>{Game.PRACTICE_MODE||this.pacman.lives--,this.nextLevel()})):(this.readyText.show(),this.resetLevel(),this.useGlobalPelletLimit=!1)}resetLevel(){this.levelStarting=!0,Ghost.NUM_EATEN=0,Ghost.NUM_FRIGHTENED=0,this.playerLabel.hide(),this.readyText.show(),this.useGlobalPelletLimit=!0,this.eatenGhosts=[],this.globalPelletCounter=0,this.pacman.reset(),this.ghosts.forEach(ghost=>{ghost.reset(),ghost.show()}),delete this.fruit,this.frightenFlashTimer.stop(),this.frightenTimer.stop(),this.energizers.forEach(e=>e.freeze()),this.startLevelTimer.start(75,()=>{this.levelComplete=!1,this.readyText.hide(),this.energizers.forEach(e=>e.unfreeze()),this.pacman.unfreeze(),this.pacman.start(),this.ghosts.forEach(g=>{g.unfreeze(),g.start()}),Input.reset(),this.lastPelletEatenTimer.start(this.maze.lastPelletEatenTimeout,()=>{this.releaseNextGhost("timeup"),this.lastPelletEatenTimer.reset()}),this.levelStarting=!1,Sound.playLoop("siren")}),this.scatterChase.reset(),this.scatterChase.tick()}endLevel(){this.levelComplete=!0,Ghost.NUM_EATEN=0,Ghost.NUM_FRIGHTENED=0,this.pacman.freeze(),this.pacman.stop(),this.ghosts.forEach(g=>g.freeze()),this.freezeTimer.start(60,()=>{this.ghosts.forEach(g=>g.hide()),this.maze.finish(),this.freezeTimer.start(96,()=>{Game.SKIP_CUTSCENES||(2==this.level?SceneManager.pushScene(new CutScene1(this.context)):5==this.level?SceneManager.pushScene(new CutScene2(this.context)):9==this.level&&SceneManager.pushScene(new CutScene3(this.context))),this.pacman.hide(),this.freezeTimer.start(15,()=>{this.level++,this.pacman.level=this.level,this.nextLevel()})})})}tick(){if(!this.startLevelTimer.tick()){var updateGhostsLater=this.ghosts.filter(ghost=>!(ghost.isEaten&&!ghost.hidden));if(!this.levelComplete)for(var i=0;i<2;i++)this.ghosts.filter(ghost=>ghost.isEaten&&!ghost.hidden).forEach(ghost=>ghost.tick());if(this.freezeTimer.tick())Sound.stop("siren");else if(this.levelComplete||this.levelStarting)Sound.stopAll();else if(this.pacman.isAlive&&(Ghost.NUM_EATEN>0?(Sound.stop("power_pellet"),Sound.playLoop("retreating")):(Sound.stop("retreating"),Ghost.NUM_FRIGHTENED>0?(Sound.stop("siren"),Sound.playLoop("power_pellet")):(Sound.stop("power_pellet"),Sound.playLoop("siren")))),this.eatenGhosts.length)this.eatGhost(this.eatenGhosts.pop());else if(this.pacman.isDead)this.freezeTimer.start(60,()=>{var otherPlayer=(this.curPlayer+1)%this.numPlayers;if(this.pacman.lives<0){if(Game.LAST_SCORES[Game.GAME_MODE][this.curPlayer]=this.pacman.score,Game.CREDITS--,2==this.numPlayers&&this.players[otherPlayer].lives>=0)return this.playerLabel.text="PLAYER "+(this.curPlayer?"TWO":"ONE"),this.playerLabel.show(),this.gameOverText.show(),void this.freezeTimer.start(90,()=>{this.gameOverText.hide(),this.loadPlayer(otherPlayer)});this.gameOverText.show(),this.creditLabel.show(),this.credits.text=""+Game.CREDITS,this.credits.show(),this.freezeTimer.start(90,()=>{Game.CREDITS?SceneManager.replaceScene(new StartScene(this.context)):SceneManager.replaceScene(new TitleScene(this.context))})}else this.numPlayers>1&&this.players[otherPlayer].lives>=0?this.loadPlayer(otherPlayer):this.resetLevel()});else{this.scatterChase.tick(),this.frightenTimer.tick(),this.frightenFlashTimer.tick(),this.pointSprite&&this.pointSprite.tick();for(var i=0;i<2;i++)this.pacman.tick(),updateGhostsLater.forEach(g=>g.tick()),this.fruit&&this.pacman.isAlive&&this.fruit.tick(),this.collisionDetect();if(this.atePellet||this.ateEnergizer){if(this.ateEnergizer&&this.frightenGhosts(),this.eatPellet(this.atePellet||this.ateEnergizer),this.atePellet=!1,this.ateEnergizer=!1,!this.pelletsLeft)return Sound.stopAll(),void this.endLevel()}else this.lastPelletEatenTimer.tick();Sound.checkSiren(this.pelletsLeft),this.useGlobalPelletLimit||this.ghosts.forEach(ghost=>{ghost.isReadyToLeaveHouse&&ghost.leaveHouse()})}}}collisionDetect(){if(this.pacman.isAlive){for(var i=0;i<this.pellets.length;i++)if(this.pacman.collideItem(this.pellets[i])){this.atePellet=this.pellets[i],this.pellets.splice(i,1);break}for(var i=0;i<this.energizers.length;i++)if(this.pacman.collideItem(this.energizers[i])){this.ateEnergizer=this.energizers[i],this.energizers.splice(i,1);break}this.fruit&&this.fruit.collide(this.pacman)&&(this.pointSprite=new Points(this,this.fruit,this.fruit.points),this.pacman.eatItem(this.fruit));for(var i=0;i<this.ghosts.length;i++){var ghost=this.ghosts[i];if(ghost.collide(this.pacman)){if(ghost.isFrightened&&!ghost.isEaten)return this.eatenGhosts.push(ghost),void ghost.eaten();if(!ghost.isEaten){if(Game.GOD_MODE)return;this.ghosts.forEach(ghost=>ghost.stop()),this.fruit&&this.fruit.stop&&this.fruit.stop(),this.pacman.freeze(),this.pacman.stop(),Sound.stopAll(),this.freezeTimer.start(45,()=>{this.ghosts.forEach(ghost=>ghost.hide()),this.pacman.die()})}}}}}releaseNextGhost(reason){for(var i=3;i>=0;i--){var ghost=this.ghosts[i];if(ghost.isHome)if(3==i||2==i){if(ghost.leaveHouse(),"timeup"==reason)break}else{if("pellet"==reason){ghost.pelletCounter++,ghost.isReadyToLeaveHouse&&ghost.leaveHouse();break}if("timeup"==reason){ghost.leaveHouse();break}}}}frightenGhosts(){this.ghosts.forEach(ghost=>ghost.frighten()),this.numGhostsEaten=0,this.frightenFlashTimer.stop(),this.frightenTimer.stop(),this.scatterChase.suspend();var fright=Ghost.getFrightenDuration(this.level),duration=fright.ticks,numFlashes,flashDuration=7*fright.flashes*4;this.frightenTimer.start(duration-flashDuration,()=>{this.ghosts.forEach(ghost=>{ghost.isFrightened&&ghost.frightenFlash()}),this.frightenFlashTimer.start(flashDuration,()=>{this.ghosts.forEach(ghost=>{ghost.isFrightened&&(this.globalChaseMode==GameScene.MODE_CHASE?ghost.chase(!0):ghost.scatter(!0),this.numGhostsEaten=0,Ghost.NUM_FRIGHTENED=0)}),this.pacman.patrol(),this.scatterChase.resume()})})}eatGhost(ghost){Sound.playOnce("eat_ghost"),this.pacman.hide(),this.ghostScore=new Points(this,ghost,this.numGhostsEaten),this.ghosts.forEach(g=>{g==ghost||g.isEaten||g.freeze()}),this.freezeTimer.start(60,()=>{Ghost.NUM_EATEN++,Ghost.NUM_FRIGHTENED--,ghost.show(),ghost.start(),this.pacman.show(),delete this.ghostScore,this.ghosts.forEach(g=>g.unfreeze())}),this.numGhostsEaten++,this.pacman.addPoints(100*Math.pow(2,this.numGhostsEaten)),4==this.numGhostsEaten&&(this.numGhostsEaten=0)}eatPellet(pellet){this.pacman.eatItem(pellet),this.lastPelletEatenTimer.reset(this.lastPelletEatenTimeout+1),this.globalPelletCounter++,!this.fruit&&this.maze.isFruitReady()&&(this.fruit=new Fruit(this)),this.useGlobalPelletLimit?7==this.globalPelletCounter?this.ghosts.Pinky.leaveHouse():17==this.globalPelletCounter?(this.ghosts.Pinky.leaveHouse(),this.ghosts.Inky.leaveHouse()):(1==this.level&&92==this.globalPelletCounter||2==this.level&&75==this.globalPelletCounter||this.level>2&&32==this.globalPelletCounter)&&(this.ghosts.Clyde.isHome&&(this.useGlobalPelletLimit=!1),this.ghosts.Pinky.leaveHouse(),this.ghosts.Inky.leaveHouse(),this.ghosts.Clyde.leaveHouse()):this.releaseNextGhost("pellet")}draw(){Scene.prototype.draw.call(this),this.oneUpLabel.flash=0==this.curPlayer,this.twoUpLabel.flash=1==this.curPlayer,this.maze.draw(),this.scoreText[this.curPlayer].text=""+(this.pacman.score||"00"),this.highScoreText.text=""+this.highScore,this.textSprites.forEach(t=>t.draw()),this.levelSprite.draw(),this.livesSprite.draw(),this.pointSprite&&this.pointSprite.draw(),this.pellets.forEach(p=>p.draw()),this.energizers.forEach(e=>e.draw()),this.fruit&&this.fruit.draw(),this.pacman.draw(),this.ghosts.forEach(g=>g.draw()),this.ghostScore&&this.ghostScore.draw()}}class MsPacmanCutScene1 extends ScriptScene{constructor(context){super(context,{1:()=>{this.take=1,this.pacman.hide(),this.pacman.animation=Pacman.ANIM_SLOMO,this.pacman.direction=Vector.RIGHT,this.pacman.stop(),this.mspacman.hide(),this.mspacman.animation=Pacman.ANIM_SLOMO,this.mspacman.direction=Vector.LEFT,this.mspacman.stop(),this.pinky.freeze(),this.pinky.hide(),this.pinky.stop(),this.inky.freeze(),this.inky.hide(),this.inky.stop(),this.pinky.direction={x:-1.15,y:0},this.pinky.nextInstruction=Vector.LEFT,this.pinky.status=Ghost.STATUS_PATROL,this.pinky.mode=Ghost.MODE_CHASE,this.inky.direction={x:1.15,y:0},this.inky.nextInstruction=Vector.RIGHT,this.inky.status=Ghost.STATUS_PATROL,this.inky.mode=Ghost.MODE_CHASE},15:()=>{this.act.show(),this.theyMeet.show(),Sound.playOnce("act1")},48:()=>{this.take++},55:()=>{this.take++},59:()=>{this.theyMeet.hide()},61:()=>{this.take--},81:()=>{this.take=0,this.act.hide()},115:()=>{this.pacman.show(),this.mspacman.show(),this.pacman.start(),this.mspacman.start(),this.mspacman.unfreeze(),this.pacman.unfreeze(),this.pacman.animation.curFrame=2},150:()=>{this.pinky.unfreeze(),this.pinky.show(),this.pinky.start(),this.inky.unfreeze(),this.inky.show(),this.inky.start()},326:()=>{this.mspacman.stop(),this.pacman.stop(),this.mspacman.y=128,this.mspacman.direction=Vector.RIGHT,this.pacman.y=128,this.pacman.x=232,this.pacman.direction=Vector.LEFT},345:()=>{this.pinky.stop(),this.pinky.hide(),this.inky.stop(),this.inky.hide(),this.pinky.y=this.mspacman.y,this.pinky.direction=Vector.inverse(this.pinky.direction),this.pinky.nextInstruction=Vector.inverse(this.pinky.nextInstruction),this.inky.y=this.pacman.y,this.inky.direction=Vector.inverse(this.pinky.direction),this.inky.nextInstruction=Vector.inverse(this.pinky.nextInstruction),this.pacman.start(),this.pacman.animation.curFrame=2,this.mspacman.start()},380:()=>{this.pinky.show(),this.inky.show(),this.pinky.start(),this.inky.start()},448:()=>{this.pacman.stop(),this.mspacman.stop()},453:()=>{this.pacman.direction=Vector.UP,this.mspacman.direction=Vector.UP,this.pacman.start(),this.pacman.animation.curFrame=2,this.mspacman.start()},472:()=>{this.pinky.stop(),this.inky.stop(),this.inkyBounce=0},476:()=>{this.pinkyBounce=0},498:()=>{this.inkyBounce=-1,this.inky.hide()},500:()=>{this.pacman.stop(),this.mspacman.stop()},502:()=>{this.pinkyBounce=-1,this.pinky.hide(),this.mspacman.animation.curFrame=1,this.pacman.animation.curFrame=1,this.pacman.direction=Vector.LEFT,this.mspacman.direction=Vector.RIGHT,this.showHeart=!0},515:()=>{this.pacman.freeze(),this.mspacman.freeze()},630:"end"}),this.level=2,this.levelSprite=new MsPacmanLevelSprite(this),this.act=new Text(this,"1","white",72,128),this.act.hide(),this.theyMeet=new Text(this,"THEY MEET","white",88,120),this.theyMeet.hide(),this.pacman=new Pacman(this,-12,100),this.mspacman=new MsPacman(this,224,204),this.pinky=new Pinky(this,224,204),this.pinkyBounce=-1,this.inky=new Inky(this,-12,100),this.inkyBounce=-1,this.drawables=[this.act,this.theyMeet,this.levelSprite,this.pacman,this.mspacman,this.pinky,this.inky],this.actors=[this.pacman,this.mspacman,this.pinky,this.inky]}get bounce(){return[[1,1],[0,0],[1,1],[0,0],[0,0],[1,0],[0,0],[1,0],[0,-1],[1,0],[0,-1],[0,0],[1,0],[0,0]]}tick(){if(ScriptScene.prototype.tick.call(this),this.pinkyBounce>-1){var move=this.bounce[this.pinkyBounce];this.pinky.x-=move[0],this.pinky.y-=move[1],this.pinkyBounce=(this.pinkyBounce+1)%this.bounce.length}if(this.inkyBounce>-1){var move=this.bounce[this.inkyBounce];this.inky.x+=move[0],this.inky.y-=move[1],this.inkyBounce=(this.inkyBounce+1)%this.bounce.length}}draw(){ScriptScene.prototype.draw.call(this);var context=this.context;if(this.showHeart&&context.drawImage(RESOURCE.mspacman,488,160,16,16,109,60,16,16),this.take){var takeOffset=32*(this.take-1);context.drawImage(RESOURCE.mspacman,456+takeOffset,208,32,32,50,105,32,32)}}}class MsPacmanCutScene2 extends ScriptScene{constructor(context){super(context,{1:()=>{this.take=1,this.pacman.stop(),this.pacman.animation=Pacman.ANIM_SLOMO,this.mspacman.stop(),this.mspacman.animation=Pacman.ANIM_SLOMO,this.pacman.hide(),this.mspacman.hide(),this.pacman.direction={x:1.9,y:0},this.mspacman.direction={x:2.4,y:0}},15:()=>{this.act.show(),this.theChase.show(),Sound.playOnce("act2")},48:()=>{this.take++},55:()=>{this.take++},59:()=>{this.theChase.hide()},61:()=>{this.take--},81:()=>{this.take=0,this.act.hide()},275:()=>{this.pacman.show(),this.pacman.unfreeze(),this.pacman.start()},310:()=>{this.mspacman.show(),this.mspacman.unfreeze(),this.mspacman.start()},550:()=>{this.mspacman.x=224,this.mspacman.y=204,this.mspacman.direction={x:-1.9,y:0}},585:()=>{this.pacman.x=224,this.pacman.y=204,this.pacman.direction={x:-2.4,y:0}},800:()=>{this.pacman.direction={x:1.9,y:0},this.pacman.x=-12,this.pacman.y=124},835:()=>{this.mspacman.direction={x:2.4,y:0},this.mspacman.x=-12,this.mspacman.y=124},1065:()=>{this.mspacman.x=224,this.mspacman.y=68,this.mspacman.direction={x:-5,y:0}},1080:()=>{this.pacman.x=224,this.pacman.y=68,this.pacman.direction={x:-5,y:0}},1120:()=>{this.pacman.direction={x:5,y:0},this.pacman.x=-12,this.pacman.y=228},1135:()=>{this.mspacman.direction={x:5,y:0},this.mspacman.x=-12,this.mspacman.y=228},1355:"end"}),this.levelSprite=new MsPacmanLevelSprite(this),this.level=5,this.act=new Text(this,"2","white",72,128),this.act.hide(),this.theChase=new Text(this,"THE CHASE","white",88,120),this.theChase.hide(),this.pacman=new Pacman(this,-12,68),this.mspacman=new MsPacman(this,-12,68),this.drawables=[this.act,this.theChase,this.levelSprite,this.mspacman,this.pacman],this.actors=[this.pacman,this.mspacman]}draw(){if(ScriptScene.prototype.draw.call(this),this.take){var takeOffset=32*(this.take-1);this.context.drawImage(RESOURCE.mspacman,456+takeOffset,208,32,32,50,105,32,32)}}}class MsPacmanCutScene3 extends ScriptScene{constructor(context){super(context,{1:()=>{Sound.playOnce("act3"),this.take=1,this.pacman.hide(),this.pacman.direction=Vector.RIGHT,this.mspacman.hide(),this.mspacman.direction=Vector.RIGHT},15:()=>{this.act.show(),this.juniorText.show()},48:()=>{this.take++},55:()=>{this.take++},59:()=>{this.juniorText.hide()},61:()=>{this.take--},81:()=>{this.take=0,this.act.hide(),this.pacman.animation.curFrame=1,this.pacman.show(),this.mspacman.animation.curFrame=1,this.mspacman.show()},90:()=>{this.bird=0},150:()=>{this.junior="drop"},278:()=>{this.junior="bounce"},305:()=>{this.junior="baby"},400:"end"}),this.levelSprite=new MsPacmanLevelSprite(this),this.level=9,this.act=new Text(this,"3","white",72,128),this.act.hide(),this.juniorText=new Text(this,"JUNIOR","white",88,120),this.juniorText.hide(),this.pacman=new Pacman(this,32,188),this.mspacman=new MsPacman(this,52,188),this.bird=-1,this.birdX=224,this.birdY=96,this.package={x:this.birdX-2,y:this.birdY+6},this.junior="carry",this.bounceCtr=0,this.drawables=[this.act,this.juniorText,this.levelSprite,this.pacman,this.mspacman]}get bounce(){return[[0,0],[0,0],[0,0],[0,-1],[-1,-1],[0,-1],[0,-1],[-1,-1],[0,0],[0,0],[-1,1],[0,1],[0,0],[0,1],[0,0],[0,1],[-1,0],[0,1],[0,1],[0,0],[0,0],[-1,1],[0,0],[0,-1],[-1,-1],[0,0],[0,0],[0,0],[0,0],[-1,0],[0,0],[0,1],[0,0],[-1,0],[0,0],[0,0],[0,0],[0,0]]}tick(){ScriptScene.prototype.tick.call(this),this.bird>-1&&this.birdX--,"carry"==this.junior?this.package.x=this.birdX-2:"drop"==this.junior?(this.package.y+=.7,this.package.x-=.4):"bounce"==this.junior&&(this.package.x+=this.bounce[this.bounceCtr][0],this.package.y+=this.bounce[this.bounceCtr][1],this.bounceCtr=this.bounceCtr+1)}draw(){ScriptScene.prototype.draw.call(this);var context=this.context;if(this.take){var takeOffset=32*(this.take-1);context.drawImage(RESOURCE.mspacman,456+takeOffset,208,32,32,50,105,32,32)}if(this.bird>-1){this.bird=(this.bird+1)%16;var xOffset=32*Math.floor(this.bird/8);context.drawImage(RESOURCE.mspacman,488+xOffset,176,32,16,this.birdX,this.birdY,32,16);var packageOffsetX="baby"==this.junior?8:0;context.drawImage(RESOURCE.mspacman,488+packageOffsetX,200,8,8,Math.floor(this.package.x),Math.floor(this.package.y),8,8)}}}class MsPacmanStartScene extends Scene{constructor(context){super(context),this.p1HighScoreP2=new Text(this,"1UP   HIGH SCORE   2UP","white",24,0),this.highScoreText=new Text(this,""+Game.getHighScore(Game.GAME_MSPACMAN),"white",128,8,"right"),this.scoreOneText=new Text(this,""+(Game.LAST_SCORES[1][0]||"00"),"white",48,8,"right"),this.scoreTwoText=new Text(this,""+Game.LAST_SCORES[1][1]||"00","white",200,8,"right"),Game.LAST_SCORES[1][1]||this.scoreTwoText.hide(),this.pushStartButton=new Text(this,"PUSH START BUTTON","orange",40,128),this.onePlayerOnly=new Text(this,"1 PLAYER ONLY","orange",56,144),this.twoPlayers=new Text(this,"1 OR 2 PLAYERS","orange",56,144),this.twoPlayerMode=new Text(this,"PRESS 2 KEY","yellow",72,160),this.twoPlayerMode.hide(),this.bonusPacman=new Text(this,"ADDITIONAL    AT 10000 pts","orange",8,192),this.copyright=new Text(this,"c MIDWAY MFG CO","red",80,232),this.dates=new Text(this,"1980/1981","red",104,248),this.creditLabel=new Text(this,"CREDIT","white",8,280),this.credits=new Text(this,""+Game.CREDITS,"white",72,280,"right")}tick(){var keyPress=Input.readKeyPress();if(!(Game.CREDITS>0&&13==keyPress))return Game.CREDITS>1&&50==keyPress?(console.log("two players"),void SceneManager.replaceScene(new GameScene(this.context,2))):void(27!=keyPress?(16==keyPress&&(Game.CREDITS++,Sound.playOnce("credit")),this.credits.text=""+Game.CREDITS,Game.CREDITS>1?(this.twoPlayers.show(),this.twoPlayerMode.show(),this.onePlayerOnly.hide()):(this.twoPlayerMode.hide(),this.twoPlayers.hide(),this.onePlayerOnly.show())):SceneManager.popScene());SceneManager.replaceScene(new GameScene(this.context,1))}draw(){Scene.prototype.draw.call(this),this.p1HighScoreP2.draw(),this.highScoreText.draw(),this.scoreOneText.draw(),this.scoreTwoText.draw(),this.pushStartButton.draw(),this.onePlayerOnly.draw(),this.twoPlayers.draw(),this.twoPlayerMode.draw(),this.bonusPacman.draw(),this.copyright.draw(),this.dates.draw(),this.context.drawImage(RESOURCE.mspacman,472,0,16,16,96,184,16,16),this.context.drawImage(RESOURCE.mspacman,456,248,32,32,40,224,32,32),this.creditLabel.draw(),this.credits.draw()}}class MsPacmanTitleScene extends ScriptScene{constructor(context){super(context,{1:()=>{this.with.hide(),this.with.text="WITH",this.actorName.hide(),this.actorName.x=96,this.actorName.color="red",this.actorName.text="BLINKY",this.ghosts.forEach(g=>{g.stop(),g.hide(),g.unfreeze(),g.mode=Ghost.MODE_CHASE,g.animation=Ghost.ANIM_SCATTER_CHASE,g.status=Ghost.STATUS_PATROL,g.direction=Vector.LEFT,g.nextInstruction=Vector.LEFT,g.position=Vector.clone(g.startPosition)}),this.mspacman.stop(),this.mspacman.hide(),this.mspacman.position=Vector.clone(this.mspacman.startPosition),this.mspacman.unfreeze(),this.mspacman.animation=Pacman.ANIM_SLOMO},60:()=>{this.with.show(),this.actorName.show(),this.blinky.start(),this.blinky.show()},244:()=>{this.blinky.direction=Vector.UP,this.blinky.nextInstruction=Vector.UP},308:()=>{this.blinky.freeze(),this.blinky.stop(),this.with.hide(),this.actorName.color="pink",this.actorName.text="PINKY",this.pinky.start(),this.pinky.show()},492:()=>{this.pinky.x=this.blinky.x,this.pinky.direction=Vector.UP,this.pinky.nextInstruction=Vector.UP},541:()=>{this.pinky.freeze(),this.pinky.stop(),this.actorName.color="blue",this.actorName.text="INKY",this.inky.start(),this.inky.show()},725:()=>{this.inky.x=this.blinky.x,this.inky.direction=Vector.UP,this.inky.nextInstruction=Vector.UP},759:()=>{this.inky.freeze(),this.inky.stop(),this.actorName.color="orange",this.actorName.text="SUE",this.actorName.x+=8,this.sue.start(),this.sue.show()},943:()=>{this.sue.x=this.blinky.x,this.sue.direction=Vector.UP,this.sue.nextInstruction=Vector.UP},961:()=>{this.sue.freeze(),this.sue.stop(),this.with.text="STARRING",this.with.show(),this.actorName.color="yellow",this.actorName.text="MS PAC-MAN",this.actorName.x=this.with.x,this.mspacman.show(),this.mspacman.start()},1071:()=>{this.mspacman.freeze(),this.mspacman.stop()},1200:"loop"}),this.p1HighScoreP2=new Text(this,"1UP   HIGH SCORE   2UP","white",24,0),this.highScoreText=new Text(this,""+Game.getHighScore(Game.GAME_MSPACMAN),"white",128,8,"right"),this.scoreOneText=new Text(this,""+(Game.LAST_SCORES[1][0]||"00"),"white",48,8,"right"),this.scoreTwoText=new Text(this,""+Game.LAST_SCORES[1][1]||"00","white",200,8,"right"),Game.LAST_SCORES[1][1]||this.scoreTwoText.hide(),this.msPacmanTitle=new Text(this,'"MS PAC-MAN"',"orange",80,56),this.copyright=new Text(this,"c MIDWAY MFG CO","red",80,232),this.dates=new Text(this,"1980/1981","red",104,248),this.creditLabel=new Text(this,"CREDIT","white",8,280),this.credits=new Text(this,""+Game.CREDITS,"white",72,280,"right"),this.with=new Text(this,"WITH","white",80,108),this.actorName=new Text(this,"BLINKY","red",96,136);for(var pelletsTop=[],pelletsRight=[],pelletsBottom=[],pelletsLeft=[],i=0;i<32;i++){var t=new Pellet(this,4*i+56+4,88);t.color="#fc0d1b",pelletsTop.push(t);var b=new Pellet(this,4*i+56,152);b.color="#fc0d1b",pelletsBottom.push(b)}for(var i=0;i<16;i++){var l=new Pellet(this,56,88+4*i);l.color="#fc0d1b",pelletsLeft.push(l);var r=new Pellet(this,184,88+4*i+4);r.color="#fc0d1b",pelletsRight.push(r)}this.pellets=pelletsTop.concat(pelletsRight.concat(pelletsBottom.reverse().concat(pelletsLeft.reverse()))),this.pelletCounters=[0,16,32,48,64,80],this.blinky=new Blinky(this,256,164),this.pinky=new Pinky(this,256,164),this.inky=new Inky(this,256,164),this.sue=new Clyde(this,256,164),this.ghosts=[this.blinky,this.pinky,this.inky,this.sue],this.mspacman=new MsPacman(this,256,164),this.level=20}tick(){var keyPress=Input.readKeyPress();if(16==keyPress)return Game.CREDITS++,Sound.playOnce("credit"),void SceneManager.pushScene(new MsPacmanStartScene(this.context));if(27!=keyPress){this.credits.text=""+Game.CREDITS,ScriptScene.prototype.tick.call(this),this.pelletCounters=this.pelletCounters.map(i=>(this.pellets[i].color="#fc0d1b",--i<0&&(i=this.pellets.length-1),this.pellets[i].color="#dedffe",i));for(var i=0;i<2;i++)this.ghosts.forEach(g=>g.tick()),this.mspacman.tick()}else SceneManager.popScene()}draw(){Scene.prototype.draw.call(this),this.p1HighScoreP2.draw(),this.highScoreText.draw(),this.scoreOneText.text=""+(Game.LAST_SCORES[1][0]||"00"),this.scoreTwoText.text=""+Game.LAST_SCORES[1][1]||"00",Game.LAST_SCORES[1][1]&&this.scoreTwoText.show(),this.scoreOneText.draw(),this.scoreTwoText.draw(),this.pellets.forEach(p=>p.draw()),this.msPacmanTitle.draw(),this.copyright.draw(),this.dates.draw(),this.with.draw(),this.actorName.draw(),this.context.drawImage(RESOURCE.mspacman,456,248,32,32,40,224,32,32),this.ghosts.forEach(g=>g.draw()),this.mspacman.draw(),this.creditLabel.draw(),this.credits.draw()}}class PacmanCutScene1 extends ScriptScene{constructor(context){super(context,{1:()=>{this.pacman.hide(),this.pacman.animation=Pacman.ANIM_NORMAL,this.pacman.direction=Vector.LEFT,this.pacman.position=Vector.clone(this.pacman.startPosition),this.pacman.stop(),this.blinky.hide(),this.blinky.status=Ghost.STATUS_PATROL,this.blinky.mode=Ghost.MODE_CHASE,this.blinky.animation=Ghost.ANIM_SCATTER_CHASE,this.blinky.direction=Vector.LEFT,this.blinky.nextInstruction=Vector.LEFT,this.blinky.position=Vector.clone(this.blinky.startPosition),this.blinky.stop()},100:()=>{Sound.playOnce("intermission"),this.pacman.show(),this.pacman.start(),this.pacman.unfreeze(),this.blinky.show(),this.blinky.start(),this.blinky.unfreeze()},310:()=>{this.pacman.stop(),this.pacman.hide(),this.pacman.animation=Pacman.ANIM_GIANT},325:()=>{this.blinky.stop(),this.blinky.hide()},375:()=>{this.blinky.direction=Vector.RIGHT,this.blinky.frighten(),this.blinky.show(),this.blinky.start()},430:()=>{Sound.playOnce("intermission")},540:()=>{this.pacman.direction=Vector.RIGHT,this.pacman.y-=16,this.pacman.show(),this.pacman.start()},722:()=>{this.blinky.stop(),this.blinky.hide()},751:()=>{this.pacman.hide(),this.pacman.stop()},850:"end"}),this.pacman=new Pacman(this,222,156),this.blinky=new Blinky(this,248,156),this.levelSprite=new PacmanLevelSprite(this),this.drawables=[this.pacman,this.blinky,this.levelSprite],this.actors=[this.pacman,this.blinky],this.level=2,this.pelletsLeft=1}}class PacmanCutScene2 extends ScriptScene{constructor(context){super(context,{1:()=>{this.rip=0,this.pacman.hide(),this.pacman.animation=Pacman.ANIM_NORMAL,this.pacman.direction=Vector.LEFT,this.pacman.position=Vector.clone(this.pacman.startPosition),this.pacman.stop(),this.blinky.hide(),this.blinky.status=Ghost.STATUS_PATROL,this.blinky.mode=Ghost.MODE_CHASE,this.blinky.animation=Ghost.ANIM_SCATTER_CHASE,this.blinky.direction=Vector.LEFT,this.blinky.nextInstruction=Vector.LEFT,this.blinky.position=Vector.clone(this.blinky.startPosition),this.blinky.stop()},100:()=>{Sound.playOnce("intermission"),this.pacman.show(),this.pacman.start(),this.pacman.unfreeze()},175:()=>{this.blinky.show(),this.blinky.start(),this.blinky.unfreeze()},290:()=>{this.pacman.stop(),this.pacman.hide()},288:()=>{this.blinky.stop()},304:()=>{this.blinky.x-=1,this.rip=1},310:()=>{this.blinky.x-=1},316:()=>{this.blinky.x-=1},322:()=>{this.blinky.x-=1,this.rip=2},328:()=>{this.blinky.x-=1},334:()=>{this.blinky.x-=1},340:()=>{this.blinky.x-=1},346:()=>{this.blinky.x-=1},352:()=>{this.blinky.x-=1,this.rip=3,this.blinky.freeze()},400:()=>{this.rip=4,this.blinky.x-=1,this.blinky.direction=Vector.RIGHT,this.blinky.nextInstruction=Vector.RIGHT,this.blinky.animation=Blinky.ANIM_RIP,this.blinky.unfreeze()},430:()=>{Sound.playOnce("intermission")},520:()=>{this.blinky.freeze()},599:()=>{Sound.stop("intermission")},600:"end"}),this.pacman=new Pacman(this,222,156),this.blinky=new Blinky(this,248,156),this.actors=[this.pacman,this.blinky],this.levelSprite=new PacmanLevelSprite(this),this.level=5}draw(){ScriptScene.prototype.draw.call(this),this.pacman.draw(),this.context.drawImage(RESOURCE.pacman,584,96,16,16,112,155,16,16),this.rip&&this.context.drawImage(RESOURCE.pacman,600+16*(this.rip-1),96,16,16,112,155,16,16),this.blinky.draw(),this.levelSprite.draw()}}class PacmanCutScene3 extends ScriptScene{constructor(context){super(context,{1:()=>{this.rip=0,this.pacman.hide(),this.pacman.animation=Pacman.ANIM_NORMAL,this.pacman.direction=Vector.LEFT,this.pacman.position=Vector.clone(this.pacman.startPosition),this.pacman.stop(),this.blinky.hide(),this.blinky.status=Ghost.STATUS_PATROL,this.blinky.mode=Ghost.MODE_CHASE,this.blinky.animation=Blinky.ANIM_PATCH,this.blinky.direction=Vector.LEFT,this.blinky.nextInstruction=Vector.LEFT,this.blinky.position=Vector.clone(this.blinky.startPosition),this.blinky.stop()},100:()=>{Sound.playOnce("intermission"),this.pacman.show(),this.pacman.start(),this.pacman.unfreeze()},120:()=>{this.blinky.show(),this.blinky.start(),this.blinky.unfreeze()},290:()=>{this.pacman.stop(),this.pacman.hide()},320:()=>{this.blinky.stop(),this.blinky.hide()},400:()=>{this.blinky.animation=Blinky.ANIM_NAKED,this.blinky.direction=Vector.RIGHT,this.blinky.nextInstruction=Vector.RIGHT,this.blinky.show(),this.blinky.start()},430:()=>{Sound.playOnce("intermission")},590:()=>{this.blinky.hide(),this.blinky.stop()},629:()=>{Sound.stop("intermission")},630:"end"}),this.pacman=new Pacman(this,222,156),this.blinky=new Blinky(this,248,156),this.levelSprite=new PacmanLevelSprite(this),this.drawables=[this.pacman,this.blinky,this.levelSprite],this.actors=[this.pacman,this.blinky],this.level=9,this.pelletsLeft=1}}class PacmanStartScene extends Scene{constructor(context){super(context),this.p1HighScoreP2=new Text(this,"1UP   HIGH SCORE   2UP","white",24,0),this.highScoreText=new Text(this,""+Game.getHighScore(Game.GAME_PACMAN),"white",128,8,"right"),this.scoreOneText=new Text(this,""+(Game.LAST_SCORES[0][0]||"00"),"white",48,8,"right"),this.scoreTwoText=new Text(this,""+Game.LAST_SCORES[0][1]||"00","white",200,8,"right"),Game.LAST_SCORES[0][1]||this.scoreTwoText.hide(),this.pushStartButton=new Text(this,"PUSH START BUTTON","orange",40,128),this.onePlayerOnly=new Text(this,"1 PLAYER ONLY","blue",56,160),this.twoPlayers=new Text(this,"1 OR 2 PLAYERS","blue",56,160),this.bonusPacman=new Text(this,"BONUS PAC-MAN FOR 10000 pts","peach",8,192),this.copyright=new Text(this,"c 1980 MIDWAY MFG.CO.","pink",32,224),this.creditLabel=new Text(this,"CREDIT","white",8,280),this.credits=new Text(this,""+Game.CREDITS,"white",72,280,"right")}tick(){var keyPress=Input.readKeyPress();Game.CREDITS>0&&13==keyPress?SceneManager.replaceScene(new GameScene(this.context,1)):Game.CREDITS>1&&50==keyPress?SceneManager.replaceScene(new GameScene(this.context,2)):27!=keyPress?(16==keyPress&&(Game.CREDITS++,Sound.playOnce("credit")),this.credits.text=""+Game.CREDITS,Game.CREDITS>1?(this.twoPlayers.show(),this.onePlayerOnly.hide()):(this.twoPlayers.hide(),this.onePlayerOnly.show())):SceneManager.popScene()}draw(){Scene.prototype.draw.call(this),this.p1HighScoreP2.draw(),this.highScoreText.draw(),this.scoreOneText.draw(),this.scoreTwoText.draw(),this.pushStartButton.draw(),this.onePlayerOnly.draw(),this.twoPlayers.draw(),this.bonusPacman.draw(),this.copyright.draw(),this.creditLabel.draw(),this.credits.draw()}}class PacmanTitleScene extends ScriptScene{constructor(context){super(context,{1:()=>{this.blinkyGhost.hide(),this.shadow.hide(),this.blinky.hide(),this.pinkyGhost.hide(),this.speedy.hide(),this.pinky.hide(),this.inkyGhost.hide(),this.bashful.hide(),this.inky.hide(),this.clydeGhost.hide(),this.pokey.hide(),this.clyde.hide(),this.pellet.hide(),this.pelletPoints.hide(),this.energizer.hide(),this.energizer.freeze(),this.energizer.animation=0,this.energizerPoints.hide(),this.copyright.hide(),this.ghostsEaten=0,this.a_energizer.hide(),this.a_energizer.freeze(),this.a_energizer.animation=0,this.pacman.hide(),this.pacman.direction=Vector.LEFT,this.pacman.position=Vector.clone(this.pacman.startPosition),this.pacman.stop(),this.a_ghosts.forEach(g=>{g.hide(),g.unfreeze(),g.status=Ghost.STATUS_PATROL,g.mode=Ghost.MODE_CHASE,g.animation=Ghost.ANIM_SCATTER_CHASE,g.direction=Vector.LEFT,g.nextInstruction=Vector.LEFT,g.position=Vector.clone(g.startPosition),g.stop()})},20:()=>{this.blinkyGhost.show()},70:()=>{this.shadow.show()},100:()=>{this.blinky.show()},120:()=>{this.pinkyGhost.show()},170:()=>{this.speedy.show()},200:()=>{this.pinky.show()},220:()=>{this.inkyGhost.show()},270:()=>{this.bashful.show()},300:()=>{this.inky.show()},320:()=>{this.clydeGhost.show()},370:()=>{this.pokey.show()},400:()=>{this.clyde.show()},480:()=>{this.pellet.show(),this.pelletPoints.show(),this.energizer.show(),this.energizerPoints.show()},540:()=>{this.a_energizer.show(),this.copyright.show()},640:()=>{this.energizer.unfreeze(),this.a_energizer.unfreeze(),this.pacman.show(),this.pacman.start(),this.pacman.unfreeze();var ctr=0;this.a_ghosts.forEach(g=>{g.frameCtr=ctr+=2,g.show(),g.unfreeze(),g.start()})},822:()=>{this.pacman.direction=Vector.RIGHT},1172:"loop"}),this.level="script",this.pauseUpdatesTimer=new Timer,this.p1HighScoreP2=new Text(this,"1UP   HIGH SCORE   2UP","white",24,0),this.scoreOneText=new Text(this,""+(Game.LAST_SCORES[0][0]||"00"),"white",48,8,"right"),this.scoreTwoText=new Text(this,""+Game.LAST_SCORES[0][1]||"00","white",200,8,"right"),Game.LAST_SCORES[0][1]||this.scoreTwoText.hide(),this.highScoreText=new Text(this,""+Game.getHighScore(Game.GAME_PACMAN),"white",128,8,"right"),this.characterNickname=new Text(this,"CHARACTER / NICKNAME","white",48,40),this.blinkyGhost=new Blinky(this,24,52),this.blinkyGhost.nextInstruction=Vector.RIGHT,this.blinkyGhost.freeze(),this.blinkyGhost.stop(),this.shadow=new Text(this,"-SHADOW","red",48,56),this.blinky=new Text(this,'"BLINKY"',"red",136,56),this.pinkyGhost=new Pinky(this,24,76),this.pinkyGhost.direction=Vector.RIGHT,this.pinkyGhost.freeze(),this.pinkyGhost.stop(),this.speedy=new Text(this,"-SPEEDY","pink",48,80),this.pinky=new Text(this,'"PINKY"',"pink",136,80),this.inkyGhost=new Inky(this,24,100),this.inkyGhost.direction=Vector.RIGHT,this.inkyGhost.freeze(),this.inkyGhost.stop(),this.bashful=new Text(this,"-BASHFUL","blue",48,104),this.inky=new Text(this,'"INKY"',"blue",136,104),this.clydeGhost=new Clyde(this,24,124),this.clydeGhost.direction=Vector.RIGHT,this.clydeGhost.freeze(),this.clydeGhost.stop(),this.pokey=new Text(this,"-POKEY","orange",48,128),this.clyde=new Text(this,'"CLYDE"',"orange",136,128),this.pellet=new Pellet(this,72,192),this.pelletPoints=new Text(this,"10 pts","white",88,192),this.energizer=new Energizer(this,72,208),this.energizer.freeze(),this.energizerPoints=new Text(this,"50 pts","white",88,208),this.copyright=new Text(this,"c 1980 MIDWAY MFG.CO.","pink",24,248),this.creditLabel=new Text(this,"CREDIT","white",8,280),this.credits=new Text(this,""+Game.CREDITS,"white",72,280,"right"),this.a_energizer=new Energizer(this,24,160),this.pacman=new Pacman(this,222,156),this.a_blinky=new Blinky(this,248,156),this.a_pinky=new Pinky(this,264,156),this.a_inky=new Inky(this,280,156),this.a_clyde=new Clyde(this,296,156),this.a_ghosts=[this.a_blinky,this.a_pinky,this.a_inky,this.a_clyde]}tick(){var keyPress=Input.readKeyPress();if(16==keyPress)return Game.CREDITS++,Sound.playOnce("credit"),void SceneManager.pushScene(new PacmanStartScene(this.context));if(27!=keyPress){if(ScriptScene.prototype.tick.call(this),this.credits.text=""+Game.CREDITS,!this.pauseUpdatesTimer.tick())for(var i=0;i<2;i++)this.a_ghosts.forEach(g=>g.tick()),this.pacman.tick(),!this.a_energizer.hidden&&this.pacman.collide(this.a_energizer)&&(this.pacman.eatItem(this.a_energizer),this.a_energizer.hide(),this.a_ghosts.forEach(g=>{g.frighten(),g.direction=Vector.RIGHT})),this.a_ghosts.forEach(g=>{!g.hidden&&this.pacman.collide(g)&&(g.hide(),g.stop(),this.pacman.hide(),this.ghostScore=new PacmanPoints(this,g,this.ghostsEaten),this.ghostsEaten++,this.a_ghosts.forEach(gg=>{gg.freeze()}),this.pauseUpdatesTimer.start(60,()=>{0!=this.ghostsEaten&&this.pacman.show(),this.a_ghosts.forEach(gg=>{gg.unfreeze()}),delete this.ghostScore}))})}else SceneManager.popScene()}draw(){Scene.prototype.draw.call(this),this.p1HighScoreP2.draw(),this.highScoreText.draw(),this.scoreOneText.text=""+(Game.LAST_SCORES[0][0]||"00"),this.scoreTwoText.text=""+Game.LAST_SCORES[0][1]||"00",Game.LAST_SCORES[0][1]&&this.scoreTwoText.show(),this.scoreOneText.draw(),this.scoreTwoText.draw(),this.characterNickname.draw(),this.blinkyGhost.draw(),this.shadow.draw(),this.blinky.draw(),this.pinkyGhost.draw(),this.speedy.draw(),this.pinky.draw(),this.inkyGhost.draw(),this.bashful.draw(),this.inky.draw(),this.clydeGhost.draw(),this.pokey.draw(),this.clyde.draw(),this.pellet.draw(),this.pelletPoints.draw(),this.energizer.draw(),this.energizerPoints.draw(),this.copyright.draw(),this.creditLabel.draw(),this.credits.draw(),this.a_energizer.draw(),this.a_ghosts.forEach(g=>{g.draw()}),this.pacman.draw(),this.ghostScore&&this.ghostScore.draw()}}class Tile{constructor(x,y,type){this.x=x,this.y=y,this.type=type}get wall(){return"."==this.type}get open(){return"0"==this.type}get pellet(){return"1"==this.type||"2"==this.type}get energizer(){return"3"==this.type}get tunnel(){return"5"==this.type}get house(){return"6"==this.type}get decision(){return"4"==this.type||"2"==this.type}get walkable(){return!this.house&&!this.wall}}class Maze{static getMazeIndex(level){return Game.GAME_MODE==Game.GAME_MSPACMAN?level<=2?0:level<=5?1:level<=9?2:level<=13?3:14==level?2:level%2?2:3:0}static getMaze(scene){if(Game.GAME_MODE!=Game.GAME_MSPACMAN)return new Pacman1(scene);switch(Maze.getMazeIndex(scene.level)){case 0:return new MsPacman1(scene);case 1:return new MsPacman2(scene);case 2:return new MsPacman3(scene);case 3:return new MsPacman4(scene)}}static initialize(){for(var y=0;y<this.wallMap.length;y++)for(var row=this.wallMap[y],x=0;x<row.length;x++){var tile=new Tile(x,y,row[x]);this.tiles.push(tile),this.tileHash[x+","+y]=tile}}static isTileType(t,attr){try{return this.tileHash[t.x+","+t.y][attr]}catch(ex){return!1}}static isDecisionTile(t){return this.isTileType(t,"decision")}static isTunnelTile(t){return this.isTileType(t,"tunnel")}static isHouseTile(t){return this.isTileType(t,"house")}static isWalkableTile(t){return this.isTileType(t,"walkable")||this.isWarpTile(t)}static isWarpTile(t){return t.x<0&&!this.isWallTile({x:0,y:t.y})||(t.x>27&&!this.isWallTile({x:27,y:t.y})||!(t.x<0||t.x>27)&&void 0)}static isWallTile(t){return!this.isWarpTile(t)&&this.isTileType(t,"wall")}constructor(scene,resource){this.scene=scene,this.resource=resource,this.context=scene.context,this.level=scene.level,this.fruitRelease=[70,170],this.complete=!1,this.flashing=!1,this.flashAnimation={frames:6,ticksPerFrame:12,curFrame:0,curFrameTicks:0}}get lastPelletEatenTimeout(){return this.scene.level<=4?240:180}isFruitReady(){return this.fruitRelease.indexOf(this.scene.pelletsEaten)>=0}chooseRandomFruitEntry(){var cls=this.constructor,choice=Math.floor(Math.random()*cls.WARP_TILES.length);return[cls.WARP_TILES[choice]].concat(cls.ENTER_TARGETS[choice])}chooseRandomFruitExit(){var cls=this.constructor,choice=Math.floor(Math.random()*cls.WARP_TILES.length);return cls.EXIT_TARGETS[choice].concat(cls.WARP_TILES[choice])}finish(){this.flashing=!0}draw(){var offsetx=this.textureOffset.x,offsety=this.textureOffset.y;this.flashing&&(this.flashAnimation.curFrameTicks++,this.flashAnimation.curFrameTicks==this.flashAnimation.ticksPerFrame&&(this.flashAnimation.curFrame++,this.flashAnimation.curFrameTicks=0,this.flashAnimation.curFrame>this.flashAnimation.frames&&(this.complete=!0)),this.flashAnimation.curFrame%2&&(offsety=248*Maze.getMazeIndex(this.scene.level),offsetx=0)),this.complete||this.context.drawImage(this.resource,offsetx,offsety,224,248,0,24,224,248),this.flashing&&this.context.clearRect(104,120,16,8)}}class MsPacman1 extends Maze{static wallMap=["............................","............................","............................","............................",".111111..1111111111..111111.",".3....1..1........1..1....3.",".1....1..1........1..1....1.",".11211211211211211211211211.","...1..1.....1..1.....1..1...","...1..1.....1..1.....1..1...","...1..1.....1..1.....1..1...","5552..1112111..1112111..2555","...1.....0........0.....1...","...1.....0........0.....1...","...2000004000000004000002...","...1.....0...66...0.....1...","...1.....0.666666.0.....1...","...1..0004.666666.4000..1...","...1..0..0.666666.0..0..1...","...1..0..0........0..0..1...","5552000..0004004000..0002555","...1........0..0........1...","...1........0..0........1...","...2111112000..0002111112...","...1.....1........1.....1...","...1.....1........1.....1...",".11211211211200211211211211.",".1....1.....1..1.....1....1.",".1....1.....1..1.....1....1.",".1....1..1111..1111..1....1.",".3....1..1........1..1....3.",".1....1..1........1..1....1.",".11111211211111111211211111.","............................","............................"];static tiles=[];static tileHash={};static WARP_TILES=[{x:-1,y:10.5},{x:-1,y:19.5},{x:28,y:10.5},{x:28,y:19.5}];static ENTER_TARGETS=[[{x:9,y:11},{x:9,y:14}],[{x:4,y:26},{x:18,y:26},{x:15,y:20}],[{x:24,y:20},{x:18,y:17}],[{x:22,y:23},{x:15,y:20}]];static EXIT_TARGETS=[[{x:9,y:14}],[{x:12,y:20},{x:10,y:23}],[{x:15,y:20},{x:18,y:23}],[{x:15,y:20},{x:18,y:23}]];constructor(board){super(board,RESOURCE.mspacman),this.pelletColor="#dedffe",this.fruitRelease=[64,172]}get textureOffset(){var scene=this.scene,pacman=scene.pacman;return 1==scene.numPlayers&&1==scene.level&&(pacman.lives>=2||!pacman.isAlive&&1==pacman.lives)?{x:0,y:992}:{x:228,y:0}}}Object.assign(MsPacman1,Maze),MsPacman1.initialize();class MsPacman2 extends Maze{static wallMap=["............................","............................","............................","............................","5555555..1111111111..5555555","......0..1........1..0......","......0..1........1..0......",".311112112111..111211211113.",".1.......1..1..1..1.......1.",".1.......1..1..1..1.......1.",".1..111112..1..1..211111..1.",".1..1....0..1111..0....1..1.",".1..1....0........0....1..1.",".111211..0........0..112111.","......1..4000000004..1......","......1..0...66...0..1......",".111112..0.666666.0..211111.",".1....1..0.666666.0..1....1.",".1....2004.666666.4002....1.",".111..1..0........0..1..111.","...1..1..0040000400..1..1...","...1..1....0....0....1..1...","...1..1....0....0....1..1...","...211211112....211112112...","...1.......1....1.......1...","...1.......1....1.......1...","5552111..1120000211..1112555","...1..1..1........1..1..1...","...1..1..1........1..1..1...",".311..2112111..1112112..113.",".1....1.....1..1.....1....1.",".1....1.....1..1.....1....1.",".11111211111211211111211111.","............................","............................"];static tiles=[];static tileHash={};static WARP_TILES=[{x:-1,y:3.5},{x:-1,y:25.5},{x:28,y:3.5},{x:28,y:25.5}];static ENTER_TARGETS=[[{x:9,y:14}],[{x:4,y:23},{x:16,y:25},{x:16,y:20}],[{x:18,y:17}],[{x:22,y:23},{x:16,y:20}]];static EXIT_TARGETS=[[{x:9,y:17},{x:9,y:7},{x:6,y:6}],[{x:14,y:26},{x:11,y:25},{x:8,y:23}],[{x:18,y:23},{x:23,y:13},{x:26,y:13}],[{x:18,y:23}]];constructor(board){super(board,RESOURCE.mspacman),this.pelletColor="#e1df31",this.textureOffset={x:228,y:248},this.fruitRelease=[64,174]}}Object.assign(MsPacman2,Maze),MsPacman2.initialize();class MsPacman3 extends Maze{static wallMap=["............................","............................","............................","............................",".111111111..1111..111111111.",".1.......1..1..1..1.......1.",".3.......1..1..1..1.......3.",".1..111212112..211212111..1.",".1..1..1....1..1....1..1..1.",".1112..1....1..1....1..2111.","....1..1....1..1....1..1....","....1..11211211211211..1....","02112....0........0....21120",".1..0....0........0....0..1.",".1..00400400000000400400..1.",".1....0..0...66...0..0....1.",".1....0..0.666666.0..0....1.",".200400..0.666666.0..004002.",".1..0....0.666666.0....0..1.",".1..0....0........0....0..1.",".1..00400400400400400400..1.",".1....0.....0..0.....0....1.",".1....0.....0..0.....0....1.",".112112..1111..1111..211211.","...1..1..1........1..1..1...","...1..1..1........1..1..1...",".311..2112112002112112..113.",".1....1.....1..1.....1....1.",".1....1.....1..1.....1....1.",".211112..1111..1111..211112.",".1....1..1........1..1....1.",".1....1..1........1..1....1.",".111111..1111111111..111111.","............................","............................"];static tiles=[];static tileHash={};static WARP_TILES=[{x:-1,y:11.5},{x:28,y:11.5}];static ENTER_TARGETS=[[{x:10,y:14}],[{x:26,y:14},{x:16,y:20}]];static EXIT_TARGETS=[[{x:12,y:20},{x:8,y:26},{x:1,y:23}],[{x:15,y:20},{x:19,y:26},{x:26,y:23}]];constructor(board){super(board,RESOURCE.mspacman)}get isAlternateVersion(){return!(this.level<=13||this.level>14&&!((this.level-1)%4))}get pelletColor(){return this.isAlternateVersion?"#2dfffe":"#fc0d1b"}get textureOffset(){return this.isAlternateVersion?{x:228,y:992}:{x:228,y:496}}}Object.assign(MsPacman3,Maze),MsPacman3.initialize();class MsPacman4 extends Maze{static wallMap=["............................","............................","............................","............................",".11121111211111111211112111.",".1..1....1........1....1..1.",".3..1....1........1....1..3.",".1..1....1..1111..1....1..1.",".1..112112..1..1..211211..1.",".1....1..1..1..1..1..1....1.",".1....1..1..1..1..1..1....1.",".112111..1112..2111..111211.","...1........0..0........1...","...1........0..0........1...","...2111..0004004000..1112...","...0..1..0...66...0..1..0...","0000..1..0.666666.0..1..0000","......2004.666666.4002......","......1..0.666666.0..1......","0000..1..0........0..1..0000","...0..1..0004004000..1..0...","...2112.....0..0.....2112...","...1..1.....0..0.....1..1...","...1..1112004..4002111..1...","...1.....1..0..0..1.....1...","...1.....1..0..0..1.....1...",".112112112..0000..211211211.",".1....1..1........1..1....1.",".1....1..1........1..1....1.",".1..111..1112112111..111..1.",".3..1.......1..1.......1..3.",".1..1.......1..1.......1..1.",".111211111111..111111112111.","............................","............................"];static WARP_TILES=[{x:-1,y:15.5},{x:-1,y:18.5},{x:28,y:15.5},{x:28,y:18.5}];static ENTER_TARGETS=[[{x:7,y:8},{x:13,y:14}],[{x:6,y:21},{x:14,y:26},{x:15,y:20}],[{x:18,y:18}],[{x:20,y:23},{x:15,y:20}]];static EXIT_TARGETS=[[{x:7,y:17}],[{x:11,y:23}],[{x:15,y:20},{x:18,y:23},{x:22,y:14}],[{x:15,y:20},{x:18,y:23}]];static tiles=[];static tileHash={};constructor(board){super(board,RESOURCE.mspacman)}get isAlternateVersion(){return!(this.level<=13||this.level>13&&this.level%4)}get pelletColor(){return this.isAlternateVersion?"#dedffe":"#d8d9f7"}get textureOffset(){return this.isAlternateVersion?{x:228,y:1240}:{x:228,y:744}}}Object.assign(MsPacman4,Maze),MsPacman4.initialize();class Pacman1 extends Maze{static wallMap=["............................","............................","............................","............................",".111112111111..111111211111.",".1....1.....1..1.....1....1.",".3....1.....1..1.....1....3.",".1....1.....1..1.....1....1.",".21111211211211211211211112.",".1....1..1........1..1....1.",".1....1..1........1..1....1.",".111112..1111..1111..211111.","......1.....0..0.....1......","......1.....0..0.....1......","......1..0000000000..1......","......1..0...66...0..1......","......1..0.666666.0..1......","5555552004.666666.4002555555","......1..0.666666.0..1......","......1..0........0..1......","......1..4000000004..1......","......1..0........0..1......","......1..0........0..1......",".111112112111..111211211111.",".1....1.....1..1.....1....1.",".1....1.....1..1.....1....1.",".311..2112111001112112..113.","...1..1..1........1..1..1...","...1..1..1........1..1..1...",".112111..1111..1111..111211.",".1..........1..1..........1.",".1..........1..1..........1.",".11111111111211211111111111.","............................","............................"];static tiles=[];static tileHash={};constructor(scene){super(scene,RESOURCE.pacman),this.pelletColor="#fcb4aa"}get textureOffset(){return{x:228,y:0}}}Object.assign(Pacman1,Maze),Pacman1.initialize();class Sprite{constructor(scene,x,y,width,height){this.scene=scene,this.context=scene.context,this.x=x,this.y=y,this.width=width,this.height=height,this.animations=[],this.currentAnimation=0}get position(){return{x:this.x,y:this.y}}set position(position){this.x=position.x,this.y=position.y}get centerPixel(){return{x:this.position.x+this.width/2,y:this.position.y+this.height/2}}get tile(){var center=this.centerPixel;return{x:Math.floor(center.x/8),y:Math.floor(center.y/8)}}hide(){this.hidden=!0}show(){this.hidden=!1}freeze(){this.frozen=!0}unfreeze(){this.frozen=!1}collide(actor){return this.tile.x==actor.tile.x&&this.tile.y==actor.tile.y}set animation(index){this.currentAnimation=index,this.animation.curFrame=0,this.animation.curFrameTicks=0}get animation(){return this.animations[this.currentAnimation]}draw(){if(!this.hidden&&!this.frozen&&this.animations.length){var currentAnimation=this.animations[this.currentAnimation];currentAnimation.ticksPerFrame>0&&currentAnimation.frames>1&&(currentAnimation.curFrameTicks++,currentAnimation.curFrameTicks>=currentAnimation.ticksPerFrame&&(currentAnimation.curFrame=(currentAnimation.curFrame+1)%currentAnimation.frames,currentAnimation.curFrameTicks=0))}}}class Text extends Sprite{static TEXT_MAP=["ABCDEFGHIJKLMNO ","PQRSTUVWXYZ!cpts",'0123456789/-".'];constructor(scene,text,color,x,y,align){super(scene,x,y),this.text=text,this.color=color,this.align=align||"left",this.flashCtr=0}get colorOffset(){return 32*(["red","pink","blue","orange","peach","yellow"].indexOf(this.color)+1)}getLetterCoordinates(letter){for(var i=0;i<Text.TEXT_MAP.length;i++){var letterIndex=Text.TEXT_MAP[i].indexOf(letter);if(letterIndex>-1)return{x:8*letterIndex,y:8*i}}}draw(){if(!this.hidden){if(this.flashCtr<16)for(var i=0;i<this.text.length;i++){var letterCoords=this.getLetterCoordinates(this.text[i]),alignX=0;"right"==this.align&&(alignX=8*(this.text.length-1)),this.context.drawImage(RESOURCE.text,letterCoords.x,letterCoords.y+this.colorOffset,8,8,this.x+8*i-alignX,this.y,8,8)}this.flash?this.flashCtr=(this.flashCtr+1)%32:this.flashCtr=0}}}class PacmanPoints extends Sprite{constructor(scene,item,score){super(scene,item.x,item.y,16,16),this.textureOffset={x:456,y:144},this.ticksToLive=80,this.score=score,this.item=item}eaten(){this.ticksToLive=0}tick(){this.ticksToLive--,this.ticksToLive<0&&delete this.scene.pointSprite}get textureOffsets(){switch(this.score){case 100:return{x:0,y:0,w:16};case 300:return{x:16,y:0,w:16};case 500:return{x:32,y:0,w:16};case 700:return{x:48,y:0,w:16};case 1e3:return{x:64,y:0,w:18};case 2e3:return{x:60,y:16,w:24};case 3e3:return{x:60,y:32,w:24};case 5e3:return{x:60,y:48,w:24};default:return{x:16*this.score,y:-16,w:16}}}draw(){if(this.ticksToLive>0){var offset=this.textureOffsets;this.context.drawImage(RESOURCE.pacman,this.textureOffset.x+offset.x,this.textureOffset.y+offset.y,offset.w,16,this.x-(offset.w-16)/2,this.y,offset.w,16)}}}class MsPacmanPoints extends PacmanPoints{constructor(scene,item,score){super(scene,item,score),this.textureOffset={x:504,y:16}}get textureOffsets(){if(!this.item.fruit)return{x:-16*(3-this.score),y:112};switch(this.score){case 100:return{x:0,y:0};case 200:return{x:16,y:0};case 500:return{x:32,y:0};case 700:return{x:48,y:0};case 1e3:return{x:64,y:0};case 2e3:return{x:80,y:0};case 5e3:return{x:96,y:0}}}draw(){if(this.ticksToLive>0){var offset=this.textureOffsets;this.context.drawImage(RESOURCE.mspacman,this.textureOffset.x+offset.x,this.textureOffset.y+offset.y,16,16,this.x,this.y,16,16)}}}class LivesSprite extends Sprite{constructor(scene){super(scene,0,0,16,16),Game.GAME_MODE==Game.GAME_PACMAN?(this.resource=RESOURCE.pacman,this.textureOffset={x:587,y:16}):(this.resource=RESOURCE.mspacman,this.textureOffset={x:472,y:0})}draw(){for(var i=0;i<Math.min(this.scene.pacman.lives,5);i++)this.context.drawImage(this.resource,this.textureOffset.x,this.textureOffset.y,this.width,this.height,(i+1)*this.width,272,this.width,this.height)}}class MsPacmanLevelSprite extends Sprite{constructor(scene){super(scene,0,0,16,16),this.textureOffset={x:504,y:0}}draw(){for(var i=0;i<Math.min(Math.max(this.scene.level,1),7);i++)this.context.drawImage(RESOURCE.mspacman,this.textureOffset.x+16*i,this.textureOffset.y,this.width,this.height,196-16*i,272,this.width,this.height)}}class PacmanLevelSprite extends Sprite{constructor(scene){super(scene,0,0,16,16),this.textureOffset={x:488,y:48}}draw(){for(var fruits=[],level=Math.max(this.scene.level,1),i=level;i>=level-6&&!(i<1);i--)fruits.unshift(PacmanFruit.getFruitIndex(i));for(var i=0;i<fruits.length;i++){var offsetX=16*fruits[i],dstX=8*(24-2*i);this.context.drawImage(RESOURCE.pacman,this.textureOffset.x+offsetX,this.textureOffset.y,this.width,this.height,dstX,272,this.width,this.height)}}}class Actor extends Sprite{static TURN_PREFERENCE=[Vector.LEFT,Vector.UP,Vector.RIGHT,Vector.DOWN];constructor(scene,x,y,width,height){super(scene,x,y,width,height),this.startPosition={x:x,y:y},this.frameCtr=0}reset(){this.show(),this.freeze(),this.position=Vector.clone(this.startPosition),this.direction=Vector.clone(this.startDirection),this.frameCtr=0}calculateNextInstruction(atTile){for(var choice=-1,closest=1/0,validChoices=[],i=0;i<Actor.TURN_PREFERENCE.length;i++){var testDirection=Actor.TURN_PREFERENCE[i];if(!Vector.equals(Vector.inverse(this.direction),testDirection)){var testTile=Vector.add(atTile,testDirection),distance=Vector.distance(testTile,this.targetTile);this.scene.mazeClass.isWalkableTile(testTile)&&(validChoices.push(i),distance<closest&&(choice=i,closest=distance))}}return this.isEaten||!this.isFrightened&&!this.randomScatter||(choice=validChoices[Math.floor(Math.random()*validChoices.length)]),Actor.TURN_PREFERENCE[choice]}get isTileCenter(){return 8*this.tile.x==this.x+4&&8*this.tile.y==this.y+4}stop(){this.stopped=!0}start(){this.stopped=!1}tick(){this.stopped||(this.x+=this.speed*this.direction.x,this.y+=this.speed*this.direction.y,this.frameCtr=(this.frameCtr+1)%32,30==this.tile.x&&1==this.direction.x?this.x=-22:-2==this.tile.x&&-1==this.direction.x&&(this.x=238))}get speed(){try{return parseInt(this.speedControl[this.frameCtr])}catch(ex){return 0}}}class Pacman extends Actor{static MODE_PATROL=0;static MODE_ENERGIZED=1;static MODE_DYING=2;static MODE_DEAD=3;static ANIM_NORMAL=0;static ANIM_DIE=1;static ANIM_GIANT=2;static ANIM_SLOMO=3;constructor(scene,x,y){super(scene,x,y,16,16),this.startDirection=Vector.LEFT,this.animations=[{frames:4,ticksPerFrame:2,curFrame:0,curFrameTicks:0,textureX:488,textureY:0},{frames:14,ticksPerFrame:8,curFrame:0,curFrameTicks:0,textureX:504,textureY:0},{frames:4,ticksPerFrame:3,curFrame:0,curFrameTicks:0,textureX:488,textureY:16},{frames:4,ticksPerFrame:4,curFrame:0,curFrameTicks:0,textureX:488,textureY:0}],this.score=0,this.reset()}reset(){Actor.prototype.reset.call(this),this.stop(),this.animation=Pacman.ANIM_NORMAL,this.mode=Pacman.MODE_PATROL}get hitBox(){return{x:this.centerPixel.x-7,y:this.centerPixel.y-7,w:14,h:15}}get centerPixel(){return{x:this.x+7,y:this.y+7}}collideItem(pellet){var pelletHitbox=pellet.hitBox;return pelletHitbox.x>this.hitBox.x&&pelletHitbox.x+pelletHitbox.w<this.hitBox.x+this.hitBox.w&&pelletHitbox.y>this.hitBox.y+1&&pelletHitbox.y+pelletHitbox.h<this.hitBox.y+this.hitBox.h}patrol(){this.isAlive&&(this.animation=Pacman.ANIM_NORMAL,this.mode=Pacman.MODE_PATROL)}get isPatrolling(){return this.mode==Pacman.MODE_PATROL}eatItem(item){item.pellet?(this.freezeDelay=2,this.freezeHalfTicks=2,this.atePellet=!0,Sound.playOnce("munch")):item.energizer?(this.freezeDelay=2,this.freezeHalfTicks=6,this.mode=Pacman.MODE_ENERGIZED,this.atePellet=!0):item.fruit&&(item.eaten(),Sound.playOnce("eat_fruit")),this.addPoints(item.points)}get isEnergized(){return this.mode==Pacman.MODE_ENERGIZED}addPoints(points){var prevScore=Math.floor(this.score/1e4),newScore;this.score+=points,prevScore!=Math.floor(this.score/1e4)&&(Sound.playOnce("extra_life"),this.lives++),this.score>this.scene.highScore&&!Game.PRACTICE_MODE&&Game.setHighScore(Game.GAME_MODE,this.score)}die(){this.freeze(),this.animation.curFrame=2,this.direction=Vector.UP,this.pellets=Array.from(this.scene.pellets),this.energizers=Array.from(this.scene.energizers),this.scene.freezeTimer.start(30,()=>{Sound.playOnce("die"),this.unfreeze(),this.mode=Pacman.MODE_DYING,this.animation=Pacman.ANIM_DIE,Game.PRACTICE_MODE||Math.max(--this.lives,-1)})}get isDying(){return this.mode==Pacman.MODE_DYING}get isDead(){return this.mode==Pacman.MODE_DEAD}get isAlive(){return!this.isDead&&!this.isDying}get isGiant(){return this.currentAnimation==Pacman.ANIM_GIANT}tick(){if(this.freezeDelay)this.freezeDelay--;else if(this.freezeHalfTicks)return void this.freezeHalfTicks--;if(Actor.prototype.tick.call(this),this.scene.maze&&this.isAlive){var inputDirection=Input.readBuffer()||this.direction,centerPoint=this.centerPixel,nextPixel={x:centerPoint.x+5*inputDirection.x,y:centerPoint.y+5*inputDirection.y},nextTile={x:Math.floor(nextPixel.x/8),y:Math.floor(nextPixel.y/8)};this.scene.mazeClass.isWalkableTile(nextTile)?(this.unfreeze(),this.start()):inputDirection=this.direction,nextPixel={x:centerPoint.x+5*inputDirection.x,y:centerPoint.y+5*inputDirection.y},nextTile={x:Math.floor(nextPixel.x/8),y:Math.floor(nextPixel.y/8)},this.scene.mazeClass.isWalkableTile(nextTile)||(this.freeze(),this.stop(),0==this.animation.curFrame&&Game.GAME_MODE==Game.GAME_PACMAN&&(this.animation.curFrame=2));var oppositeDirection=Vector.equals(inputDirection,Vector.inverse(this.direction));if(this.direction=inputDirection,!this.stopped&&!oppositeDirection){var centerX=8*this.tile.x+3,centerY=8*this.tile.y+3;this.direction.x&&(this.centerPixel.y>centerY?this.y-=.5:this.centerPixel.y<centerY&&(this.y+=.5)),this.direction.y&&(this.centerPixel.x>centerX?this.x-=.5:this.centerPixel.x<centerX&&(this.x+=.5))}}}get directionalOffsetY(){return this.direction.x>=1?0:this.direction.x<=-1?16:this.direction.y<=-1?32:this.direction.y>=1?48:void 0}get frameOffsetX(){switch(this.animation.curFrame){case 3:return-1;default:return-this.animation.curFrame}}draw(){if(!this.hidden){Actor.prototype.draw.call(this);var context=this.context,animation=this.animation;if(this.isAlive){var curFrame=animation.curFrame,frameOffsetX=this.frameOffsetX,directionalOffsetY=this.directionalOffsetY,width=this.width,height=this.height;0==curFrame&&(directionalOffsetY=0),this.isGiant?(directionalOffsetY=16,width=32,height=32,frameOffsetX*=-32):frameOffsetX*=16,context.drawImage(RESOURCE.pacman,animation.textureX+frameOffsetX,directionalOffsetY,width,height,this.x,this.y,width,height)}else context.drawImage(RESOURCE.pacman,animation.textureX+16*animation.curFrame,0,16,16,this.x,this.y,16,16),13==animation.curFrame&&(this.freeze(),this.mode=Pacman.MODE_DEAD)}}get speedControl(){return this.stopped||!this.isAlive?"00000000000000000000000000000000":this.isPatrolling?1==this.scene.level?"01010101010101010101010101010101":this.scene.level<=4?"11010101011010101101010101101010":this.scene.level<=20?"01101101011011010110110101101101":"11010101011010101101010101101010":this.isEnergized?1==this.scene.level?"11010101011010101101010101101010":this.scene.level<=4?"11010110010110101010110110110101":this.scene.level<=20?"01101101011011010110110101101101":"11010101011010101101010101101010":void 0}}class MsPacman extends Pacman{constructor(scene,x,y){super(scene,x,y,16,16),this.animations=[{frames:4,ticksPerFrame:2,curFrame:0,curFrameTicks:0,textureX:488,textureY:0},{frames:11,ticksPerFrame:8,curFrame:0,curFrameTicks:0,textureX:472,textureY:48},{},{frames:4,ticksPerFrame:4,curFrame:0,curFrameTicks:0,textureX:488,textureY:0}]}die(){Pacman.prototype.die.call(this),this.animation.curFrameTicks=0,this.animation.curFrame=1,this.direction=Vector.DOWN,this.nextDirection=Vector.DOWN}draw(){if(!this.hidden){Actor.prototype.draw.call(this);var context=this.context,animation=this.animation;this.isAlive?context.drawImage(RESOURCE.mspacman,animation.textureX+16*this.frameOffsetX,this.directionalOffsetY,16,16,this.x,this.y,16,16):(this.direction=Actor.TURN_PREFERENCE[animation.curFrame%4],context.drawImage(RESOURCE.mspacman,animation.textureX,this.directionalOffsetY,16,16,this.x,this.y,16,16),9==animation.curFrame&&(this.freeze(),this.mode=Pacman.MODE_DEAD))}}}class Ghost extends Actor{static MODE_CHASE=0;static MODE_SCATTER=1;static MODE_FRIGHT=2;static MODE_EATEN=3;static STATUS_LEAVE_HOME=0;static STATUS_ENTER_HOME=1;static STATUS_HOME=2;static STATUS_PATROL=3;static ANIM_SCATTER_CHASE=0;static ANIM_FRIGHT=1;static ANIM_FRIGHT_FLASH=2;static ANIM_EATEN=3;static NUM_EATEN=0;static NUM_FRIGHTENED=0;static HOUSE_DOOR={x:13,y:14};static LEAVE_TARGET={x:104,y:108};static getFrightenDuration(level){var time=0,flashes=0;return level<=5?(time=7-level,flashes=5):6==level||10==level?(time=5,flashes=5):level<=8||11==level?(time=2,flashes=5):14==level?(time=3,flashes=5):17==level||level>18?(time=0,flashes=0):(9==level||level<=18)&&(time=1,flashes=3),{ticks:60*time,flashes:flashes}}constructor(scene,x,y){super(scene,x,y,16,16),this.houseTarget=this.startPosition,this.animations=[{frames:2,ticksPerFrame:8,curFrame:0,curFrameTicks:0,textureX:456,textureY:64},{frames:2,ticksPerFrame:8,curFrame:0,curFrameTicks:0,textureX:584,textureY:64},{frames:4,ticksPerFrame:7,curFrame:0,curFrameTicks:0,textureX:584,textureY:64},{frames:1,ticksPerFrame:0,curFrame:0,curFrameTicks:0,textureX:584,textureY:80}],this.currentAnimation=0,this.pelletCounter=0}reset(){Actor.prototype.reset.call(this),this.nextInstruction=Vector.clone(this.direction),this.status=Ghost.STATUS_HOME,this.mode=Ghost.MODE_SCATTER,this.animation=Ghost.ANIM_SCATTER_CHASE,this.targetTile=this.calculateTargetTile(),delete this.reverseInstruction}get pelletLimit(){return 0}get inTunnel(){try{return this.scene.mazeClass.isTunnelTile(this.tile)}catch(ex){return!1}}frighten(){this.reverse(),this.isEaten||(this.mode=Ghost.MODE_FRIGHT,this.animation=Ghost.ANIM_FRIGHT,Ghost.NUM_FRIGHTENED++)}frightenFlash(){this.animation=Ghost.ANIM_FRIGHT_FLASH}get isFrightened(){return this.mode==Ghost.MODE_FRIGHT}reverse(){this.reverseInstruction=Vector.inverse(this.direction),this.reverseInstruction.reverse=!0}scatter(){this.isEaten||(this.reverse(),this.mode=Ghost.MODE_SCATTER,this.animation=Ghost.ANIM_SCATTER_CHASE,this.targetTile=this.calculateTargetTile())}get isScattering(){return this.mode==Ghost.MODE_SCATTER}chase(noReverse){this.isEaten||(noReverse||this.reverse(),this.mode=Ghost.MODE_CHASE,this.animation=Ghost.ANIM_SCATTER_CHASE,this.targetTile=this.calculateTargetTile())}get isChasing(){return this.mode==Ghost.MODE_CHASE}eaten(){this.hide(),this.stop(),this.mode=Ghost.MODE_EATEN,this.targetTile=Ghost.HOUSE_DOOR,this.animation=Ghost.ANIM_EATEN}get isEaten(){return this.mode==Ghost.MODE_EATEN}leaveHouse(){this.isHome&&(this.position.x>Ghost.LEAVE_TARGET.x?this.direction=Vector.LEFT:this.position.x<Ghost.LEAVE_TARGET.x?this.direction=Vector.RIGHT:this.position.y>Ghost.LEAVE_TARGET.y&&(this.direction=Vector.UP),this.status=Ghost.STATUS_LEAVE_HOME)}get isReadyToLeaveHouse(){return this.isHome&&this.pelletCounter>=this.pelletLimit}get isHome(){return this.status==Ghost.STATUS_HOME}get isEnteringHome(){return this.status==Ghost.STATUS_ENTER_HOME}get isLeavingHome(){return this.status==Ghost.STATUS_LEAVE_HOME}calculateTargetTile(){return this.isScattering?this.scatterTargetTile:this.isFrightened?this.scatterTargetTile:this.isEaten?Ghost.HOUSE_DOOR:void 0}tick(){if(this.scene.maze){if(this.targetTile=this.calculateTargetTile(),this.isHome)Math.ceil(this.position.y)<=128?this.direction=Vector.DOWN:Math.floor(this.position.y)>=136&&(this.direction=Vector.UP);else if(this.isEnteringHome)this.position.y<this.houseTarget.y?this.direction=Vector.DOWN:this.position.x<this.houseTarget.x?this.direction=Vector.RIGHT:this.position.x>this.houseTarget.x?this.direction=Vector.LEFT:(this.status=Ghost.STATUS_HOME,this.animation=Ghost.ANIM_SCATTER_CHASE,this.direction=Vector.UP,this.mode=this.scene.globalChaseMode,Ghost.NUM_EATEN--);else if(this.isLeavingHome)this.isEaten?this.status=Ghost.STATUS_ENTER_HOME:this.position.x>Ghost.LEAVE_TARGET.x?this.direction=Vector.LEFT:this.position.x<Ghost.LEAVE_TARGET.x?this.direction=Vector.RIGHT:this.position.y>Ghost.LEAVE_TARGET.y?this.direction=Vector.UP:(this.status=Ghost.STATUS_PATROL,this.direction=Vector.LEFT,this.exitingHouse=!0,this.reverseInstruction?(this.nextInstruction=Vector.RIGHT,delete this.reverseInstruction):this.nextInstruction=Vector.LEFT,this.isFrightened||(this.mode=this.scene.globalChaseMode));else if(this.isTileCenter&&!this.madeInstruction){if(this.madeInstruction=!0,this.reverseInstruction){var nextTile=Vector.add(this.tile,this.reverseInstruction);this.scene.mazeClass.isWallTile(nextTile)?this.nextInstruction=Vector.inverse(this.lastDirection):this.nextInstruction=Vector.clone(this.reverseInstruction),delete this.reverseInstruction}this.lastDirection=Vector.clone(this.direction),this.direction=Vector.clone(this.nextInstruction);var nextTile=Vector.add(this.tile,this.direction),futureTile=Vector.add(nextTile,this.direction);if((this.scene.mazeClass.isDecisionTile(nextTile)||this.scene.mazeClass.isWallTile(futureTile))&&(this.nextInstruction=this.calculateNextInstruction(nextTile)),!this.nextInstruction){var nextDirection=this.calculateNextInstruction(this.tile)||this.direction;this.nextInstruction=Vector.clone(nextDirection)}}else this.isTileCenter||(this.madeInstruction=!1),this.isEaten&&!this.isEnteringHome?Vector.equals(this.position,Ghost.LEAVE_TARGET)&&(this.direction=Vector.DOWN,this.status=Ghost.STATUS_ENTER_HOME):this.exitingHouse&&(this.y=8*(this.tile.y-1)+4,this.exitingHouse=!1);Actor.prototype.tick.call(this)}else Actor.prototype.tick.call(this)}draw(){if(!this.hidden){Actor.prototype.draw.call(this);var context=this.context,animation=this.animation,directionalOffsetX=0,offsetY=0,eyes;if(!this.isFrightened)offsetY=this.textureOffsetY,-1==(eyes=this.isHome||this.isLeavingHome?this.direction:this.madeInstruction||this.nextInstruction.reverse?this.direction:this.nextInstruction||this.direction).x?directionalOffsetX=32:-1==eyes.y?directionalOffsetX=64:1==eyes.y&&(directionalOffsetX=96),this.mode==Ghost.MODE_EATEN&&(offsetY=0,directionalOffsetX/=2);context.drawImage(RESOURCE.pacman,animation.textureX+directionalOffsetX+animation.curFrame*this.width,animation.textureY+offsetY,this.width,this.height,this.x,this.y,this.width,this.height)}}get speedControl(){try{if(this.isEaten)return"11111111111111111111111111111111";if(this.isHome||this.isLeavingHome)return"00010001000100010001000100010001";if(this.inTunnel)return 1==this.scene.level?"00100010001000100010001000100010":this.scene.level<=4?"01001000001001000010001010010001":"10010010001001001001001000100100";if(this.isFrightened)return 1==this.scene.level?"10010010001001001001001000100100":this.scene.level<=4?"10010010001001000010010101001001;":this.scene.level<=20?"00100101001001010010010100100101":"01001000001001000010001010010001";if(1==this.elroy)return 1==this.scene.level?"10101010101010101010101010101010":this.scene.level<=4?"11010101011010101101010101101010":"01101101011011010110110101101101";if(2==this.elroy)return 1==this.scene.level?"101010100110101001010101110101010":this.scene.level<=4?"101101011001011010101011011011010":"101101100110110101101101110110110"}catch(ex){console.log(ex)}return 1==this.scene.level?"10101010001010100101010101010101":this.scene.level<=4?"10101010011010100101010111010101":(this.scene.level,"11010110010110101010110110110101")}}class Blinky extends Ghost{static ANIM_RIP=4;static ANIM_PATCH=5;static ANIM_NAKED=6;constructor(scene,x,y){super(scene,x,y),this.name="Blinky",this.houseTarget={x:104,y:132},this.startDirection=Vector.LEFT,this.scatterTargetTile={x:25,y:0},this.textureOffsetY=0,this.animations=this.animations.concat([{frames:2,ticksPerFrame:70,curFrame:0,curFrameTicks:0,textureX:584,textureY:112},{frames:2,ticksPerFrame:8,curFrame:0,curFrameTicks:0,textureX:584,textureY:112},{frames:2,ticksPerFrame:8,curFrame:0,curFrameTicks:0,textureX:584,textureY:128}]),this.reset()}reset(){Ghost.prototype.reset.call(this),this.status=Ghost.STATUS_PATROL}get randomScatter(){return this.scene.scatterChase.randomScatter}calculateTargetTile(){return this.isChasing?Vector.clone(this.scene.pacman.tile):Ghost.prototype.calculateTargetTile.call(this)}tick(){this.isHome&&this.leaveHouse(),Ghost.prototype.tick.call(this)}draw(){if(this.currentAnimation==Blinky.ANIM_NAKED){Sprite.prototype.draw.call(this);var animation=this.animation;this.context.drawImage(RESOURCE.pacman,animation.textureX+32*animation.curFrame,animation.textureY,32,this.height,this.position.x-16,this.position.y,32,this.height)}else Ghost.prototype.draw.call(this)}get elroy(){if(this.scene.pelletsLeft>0){if(this.scene.pelletsLeft<=this.elroy2PelletsLeft)return 2;if(this.scene.pelletsLeft<=this.elroy1PelletsLeft)return 1}return 0}get elroy1PelletsLeft(){return 2*this.elroy2PelletsLeft}get elroy2PelletsLeft(){return 1==this.scene.level?10:2==this.scene.level?15:this.scene.level<=5?20:this.scene.level<=8?25:this.scene.level<=11?30:this.scene.level<=14?40:this.scene.level<=18?50:60}}class Pinky extends Ghost{constructor(scene,x,y){super(scene,x,y),this.name="Pinky",this.startDirection=Vector.DOWN,this.textureOffsetY=16,this.scatterTargetTile={x:2,y:0},this.reset()}get randomScatter(){return this.scene.scatterChase.randomScatter}calculateTargetTile(){if(this.isChasing){var pacmanDirection=this.scene.pacman.direction,targetTile=Vector.clone(this.scene.pacman.tile);return targetTile.x+=4*pacmanDirection.x,targetTile.y+=4*pacmanDirection.y,pacmanDirection.y<0&&(targetTile.x-=4),targetTile}return Ghost.prototype.calculateTargetTile.call(this)}}class Inky extends Ghost{constructor(scene,x,y){super(scene,x,y),this.name="Inky",this.startDirection=Vector.UP,this.textureOffsetY=32,this.scatterTargetTile={x:27,y:35},this.reset()}get pelletLimit(){return 1==this.scene.level?30:0}calculateTargetTile(){if(this.isChasing){var blinkyTile=this.scene.ghosts.Blinky.tile,pacmanTile=this.scene.pacman.tile,pacmanDirection=this.scene.pacman.direction,targetTile={x:pacmanTile.x+2*pacmanDirection.x,y:pacmanTile.y+2*pacmanDirection.y};return pacmanDirection.y<0&&(targetTile.x-=2),this.ptile=Vector.clone(targetTile),targetTile.x+=targetTile.x-blinkyTile.x,targetTile.y+=targetTile.y-blinkyTile.y,targetTile}return Ghost.prototype.calculateTargetTile.call(this)}}class Clyde extends Ghost{constructor(scene,x,y){super(scene,x,y),this.name="Clyde",this.startDirection=Vector.UP,this.textureOffsetY=48,this.scatterTargetTile={x:0,y:35},this.reset()}get pelletLimit(){return 1==this.scene.level?60:2==this.scene.level?50:0}calculateTargetTile(){if(this.isChasing){var pacmanTile=this.scene.pacman.tile,distance;return Vector.distance(this.tile,pacmanTile)>8?Vector.clone(pacmanTile):this.scatterTargetTile}return Ghost.prototype.calculateTargetTile.call(this)}}class ScatterChase{constructor(scene){this.scene=scene,this.reset()}get randomScatter(){return Game.GAME_MODE==Game.GAME_MSPACMAN&&0==this.phase&&this.phaseTimesRemaining.scatter>0}reset(){this.phase=0,this.setTimers(),this.suspended=!1,this.scene.globalChaseMode=GameScene.MODE_SCATTER}setTimers(){var phaseTimes=this["phase"+this.phase];this.phaseTimesRemaining={scatter:phaseTimes.scatter,chase:phaseTimes.chase}}nextPhase(){this.phase++,this.setTimers()}suspend(){this.suspended=!0}resume(){this.suspended=!1}get phase0(){return{scatter:this.scene.level<=4?420:300,chase:1200}}get phase1(){return this.phase0}get phase2(){var chase;return{scatter:420,chase:chase=1==this.scene.level?1200:this.scene.level<=4?61980:62220}}get phase3(){return{scatter:1==this.scene.level?420:1,chase:1/0}}tick(){this.suspended||(this.phaseTimesRemaining.scatter>0?(this.phaseTimesRemaining.scatter--,0==this.phaseTimesRemaining.scatter&&(this.scene.globalChaseMode=GameScene.MODE_CHASE,this.scene.ghosts.forEach(ghost=>ghost.chase()))):this.phaseTimesRemaining.chase>0&&(this.phaseTimesRemaining.chase--,0==this.phaseTimesRemaining.chase&&(this.nextPhase(),this.scene.globalChaseMode=GameScene.MODE_SCATTER,this.scene.ghosts.forEach(ghost=>ghost.scatter()))))}}class Pellet extends Sprite{constructor(scene,x,y){super(scene,x,y,8,8),this.points=10,this.pellet=!0}get pelletColor(){return this.color||(this.scene.maze||{}).pelletColor||"#fcb4aa"}get hitBox(){return{x:this.x+3,y:this.y+3,w:2,h:2}}draw(){if(!this.hidden){var context=this.context;context.beginPath(),context.fillStyle=this.pelletColor,context.fillRect(this.x+3,this.y+3,2,2),context.fill()}}}class Energizer extends Pellet{constructor(scene,x,y){super(scene,x,y),this.animations=[{frames:2,ticksPerFrame:10,curFrame:0,curFrameTicks:0}],this.points=50,this.pellet=!1,this.energizer=!0}draw(){if(!this.hidden&&(Sprite.prototype.draw.call(this),0==this.animation.curFrame)){var context=this.context;context.fillStyle=this.pelletColor,context.fillRect(this.x+1,this.y+1,6,6),context.fillRect(this.x,this.y+2,8,4),context.fillRect(this.x+2,this.y,4,8),context.fill()}}}class MsPacmanFruit extends Actor{static MODE_ENTER=0;static MODE_LOOP=1;static MODE_EXIT=2;static HOUSE_TARGET={x:13,y:18};constructor(scene){super(scene,-16,-16,16,16),this.fruit=!0,this.level=this.scene.level,this.level>7&&(this.level=Math.floor(7*Math.random())),this.textureOffset={x:504,y:0},this.bounceCtr=0,this.mode=MsPacmanFruit.MODE_ENTER,this.enterSequence=this.scene.maze.chooseRandomFruitEntry(),this.x=8*this.enterSequence[0].x,this.y=8*this.enterSequence[0].y,this.direction=this.x<1?Vector.RIGHT:Vector.LEFT,this.x-=4*this.direction.x,this.turn=1,this.targetTile=this.enterSequence[this.turn]}get speedControl(){return"00100010001000100010001000100010"}get hitBox(){return{x:this.x+4,y:this.y+4,w:8,h:8}}get points(){return[100,200,500,700,1e3,2e3,5e3][this.level-1]}eaten(){delete this.scene.fruit}get isExiting(){return this.mode==MsPacmanFruit.MODE_EXIT}get isEntering(){return this.mode==MsPacmanFruit.MODE_ENTER}get isLooping(){return this.mode==MsPacmanFruit.MODE_LOOP}get isDone(){return this.mode==MsPacmanFruit.MODE_DONE}tick(){if(Actor.prototype.tick.call(this),this.frozen||(this.bounceCtr++,this.bounceCtr%8==0&&Sound.playOnce("fruit_bounce")),this.isTileCenter&&!this.madeInstruction){this.isEntering&&Vector.equals(this.tile,this.enterSequence[this.turn])?(this.turn<this.enterSequence.length-1?this.targetTile=this.enterSequence[++this.turn]:(this.loopTarget=Vector.clone(this.targetTile),this.turn=0,this.mode=MsPacmanFruit.MODE_LOOP,this.targetTile=MsPacmanFruit.HOUSE_TARGET),this.madeInstruction=!0):this.isLooping&&Vector.equals(this.tile,this.loopTarget)?(this.exitSequence=this.scene.maze.chooseRandomFruitExit(),this.mode=MsPacmanFruit.MODE_EXIT,this.targetTile=this.exitSequence[this.turn],Vector.equals(this.targetTile,this.tile)&&(this.targetTile=this.exitSequence[++this.turn])):this.isExiting&&Vector.equals(this.tile,this.targetTile)?this.turn<this.exitSequence.length-1&&(this.targetTile=this.exitSequence[++this.turn]):this.isExiting&&(this.tile.x<0||this.tile.x>27)&&delete this.scene.fruit;var centerPoint=this.centerPixel,nextPixel={x:centerPoint.x+5*this.direction.x,y:centerPoint.y+5*this.direction.y},testTile={x:Math.floor(nextPixel.x/8),y:Math.floor(nextPixel.y/8)};(this.scene.mazeClass.isWallTile(testTile)||this.scene.mazeClass.isHouseTile(testTile)||this.scene.mazeClass.isDecisionTile(this.tile))&&(this.direction=this.calculateNextInstruction(this.tile),this.madeInstruction=!0)}else this.isTileCenter||delete this.madeInstruction}draw(){Actor.prototype.draw.call(this);var offsetX=16*(this.level-1),offsetBounce=1.5*Math.sin(this.bounceCtr/16*Math.PI)-.5;this.context.drawImage(RESOURCE.mspacman,this.textureOffset.x+offsetX,this.textureOffset.y,16,16,this.x,this.y+offsetBounce,16,16)}}class PacmanFruit extends Sprite{static POINTS=[100,300,500,700,1e3,2e3,3e3,5e3];static getFruitIndex(level){switch(level){case 1:return 0;case 2:return 1;case 3:case 4:return 2;case 5:case 6:return 3;case 7:case 8:return 4;case 9:case 10:return 5;case 11:case 12:return 6;default:return 7}}constructor(scene){super(scene,104,156,16,16),this.textureOffset={x:488,y:48},this.halfTicksToLive=120*(Math.random()*(2/3)+28/3),this.fruit=!0}get points(){return PacmanFruit.POINTS[PacmanFruit.getFruitIndex(this.scene.level)]}get hitBox(){return{x:this.position.x+6,y:this.position.y,w:2,h:8}}collide(pacman){return pacman.centerPixel.x<=this.hitBox.x+this.hitBox.w&&pacman.centerPixel.x>=this.hitBox.x&&pacman.centerPixel.y<=this.hitBox.y+this.hitBox.h&&pacman.centerPixel.y>=this.hitBox.y}eaten(){this.halfTicksToLive=0}tick(){this.halfTicksToLive--,this.halfTicksToLive<0&&delete this.scene.fruit}draw(){if(this.halfTicksToLive>0){var offsetX=16*PacmanFruit.getFruitIndex(this.scene.level);this.context.drawImage(RESOURCE.pacman,this.textureOffset.x+offsetX,this.textureOffset.y,16,16,this.x,this.y,16,16)}}}class Game{static GOD_MODE=!1;static SKIP_CUTSCENES=!1;static PRACTICE_MODE=!1;static GAME_PACMAN=0;static GAME_MSPACMAN=1;static GAME_MODE=0;static CREDITS=0;static LAST_SCORES=[[0,null],[0,null]];static TEMP_HIGH_SCORE=0;static getHighScore(mode){try{return parseInt(localStorage["highscore_"+mode]||"0")}catch(ex){var oldHigh=Math.max(...this.LAST_SCORES[mode]),high;return Math.max(oldHigh,this.TEMP_HIGH_SCORE)}}static setHighScore(mode,score){try{localStorage["highscore_"+mode]=score}catch(ex){}finally{this.TEMP_HIGH_SCORE=Math.max(this.TEMP_HIGH_SCORE,score)}}constructor(el,scale){this.el=(el?document.getElementById(el):document.body)||document.body,this.pauseGame=!1,this.wasPaused=!1,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.scale=scale||2,this.canvas.width=224*this.scale,this.canvas.height=288*this.scale,this.context.webkitImageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.imageSmoothingEnabled=!1,this.context.scale(this.scale,this.scale),this.canvas.style.background="black",this.canvas.style.border="solid",this.el.appendChild(this.canvas),SceneManager.pushScene(new CreditsScene(this.context)),this.fpsLimit=60,this.previousDelta=0,window.requestAnimationFrame(d=>this.loop(d))}loop(currentDelta){var delta=currentDelta-this.previousDelta;this.fpsLimit&&delta<1e3/this.fpsLimit?window.requestAnimationFrame(d=>this.loop(d)):(this.pauseGame||(Input.watch(),SceneManager.update()),this.pauseGame&&!this.wasPaused?Sound.suspend():!this.pauseGame&&this.wasPaused&&Sound.resume(),this.wasPaused=this.pauseGame,window.requestAnimationFrame(d=>this.loop(d)),this.previousDelta=currentDelta)}}var TitleScene,StartScene,CutScene1,CutScene2,CutScene3,LevelSprite,PacClass,Points,Fruit,RESOURCE={mspacman:new Image,pacman:new Image,text:new Image};RESOURCE.mspacman.src="res/mspacman/mspacman.png",RESOURCE.pacman.src="res/pacman/pacman.png",RESOURCE.text.src="res/text.png";var GAME=new Game(null,2);